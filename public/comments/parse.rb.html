<!DOCTYPE html>
<html lang="en-GB">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width">
    <link rel="alternate" type="text/markdown" href="parse.rb.md">
    <style>
      body {
        max-width: 40rem;
        margin: auto;
        padding: 2rem 1rem;
        font-family: 'Helvetica Neue','Helvetica', system-ui;
        color: black;
        background-color: white;
      }
      p {line-height: 1.4;}
      code {
      line-height: 1.4;
      color:gray;
      }
      code pre {white-space: pre-wrap; word-break: break-word;}
      code:hover {color:black;}
      h1, h2 {font-weight:normal;}
      a {text-decoration:none;}
      a.githubline {color:gray;font-weight:bold;}
      @media (prefers-color-scheme: dark) {
body {color:white;background-color:black;}
a {text-decoration:underline;color:white;}
}
    </style>
    <title>lib/parsing/parse.rb</title>
  </head>
  <body><p><a href="/procedures/meta/comments">/procedures/meta/comments</a></p><h1>Module containing the main parsing code.</h1>
<p>Design notes for the <a href="https://ukparliament.github.io/ontologies/procedure/flowcharts/meta/design-notes/#procedure-maps-with-logic-gates">parsing of a procedure map with logic gates are here</a>.</p>
<code title='Line 3, lib/parsing/parse.rb'><pre><a name='3'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/lib/parsing/parse.rb#L3'> 3</a> module PARSE
</pre></code><h2>Method to parse a route.</h2>
<p>We pass in the ID of the route to be parsed.</p>
<code title='Line 7, lib/parsing/parse.rb'><pre><a name='7'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/lib/parsing/parse.rb#L7'> 7</a>   def parse_route_with_id( route_id )
</pre></code><p>A route being parsed as part of the set of routes originating from a start step may have already been parsed, because a route subsequent to one of the routes from the start step may have that start step as its target.</p>
<p>We only wish to parse a route if it has not already been parsed.</p>
<p>Unless this route has been parsed ...</p>
<code title='Line 12, lib/parsing/parse.rb'><pre><a name='12'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/lib/parsing/parse.rb#L12'> 12</a>     unless route_parsed_attribute( route_id ) == true
</pre></code><p>... we increment the parse pass count for this route, ...</p>
<code title='Line 15, lib/parsing/parse.rb'><pre><a name='15'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/lib/parsing/parse.rb#L15'> 15</a>       parse_pass_count = route_parse_pass_count_attribute( route_id ) + 1
</pre></code><p>... we update the route hash with that count ...</p>
<code title='Line 18, lib/parsing/parse.rb'><pre><a name='18'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/lib/parsing/parse.rb#L18'> 18</a>       update_route_hash( route_id, nil, nil, nil, parse_pass_count )
</pre></code><p>... and increment the total parse pass count.</p>
<code title='Line 21, lib/parsing/parse.rb'><pre><a name='21'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/lib/parsing/parse.rb#L21'> 21</a>       @parse_pass_count += 1
</pre></code><p>The route and its attributes are logged.</p>
<code title='Line 24, lib/parsing/parse.rb'><pre><a name='24'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/lib/parsing/parse.rb#L24'> 24</a>       @parse_log << "Parsing route from <strong>#{route_source_step_name( route_id )} (#{route_source_step_type( route_id )})</strong> to <strong>#{route_target_step_name( route_id )} (#{route_target_step_type( route_id )})</strong> [#{@parse_pass_count}/#{@route_count}]."
</pre></code><h3>We check the type of the source step of the route we&#39;re parsing and parse the route accordingly.</h3>
<p>For each parse method we pass the ID of the route to be parsed.</p>
<code title='Line 28, lib/parsing/parse.rb'><pre><a name='28'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/lib/parsing/parse.rb#L28'> 28</a>       case route_source_step_type( route_id )
</pre></code><code title='Line 29, lib/parsing/parse.rb'><pre><a name='29'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/lib/parsing/parse.rb#L29'> 29</a>       when "Business step"
</pre></code><code title='Line 30, lib/parsing/parse.rb'><pre><a name='30'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/lib/parsing/parse.rb#L30'> 30</a>         parse_route_from_business_step( route_id )
</pre></code><code title='Line 31, lib/parsing/parse.rb'><pre><a name='31'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/lib/parsing/parse.rb#L31'> 31</a>       when "Decision"
</pre></code><code title='Line 32, lib/parsing/parse.rb'><pre><a name='32'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/lib/parsing/parse.rb#L32'> 32</a>         parse_route_from_decision_step( route_id )
</pre></code><code title='Line 33, lib/parsing/parse.rb'><pre><a name='33'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/lib/parsing/parse.rb#L33'> 33</a>       when "NOT"
</pre></code><code title='Line 34, lib/parsing/parse.rb'><pre><a name='34'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/lib/parsing/parse.rb#L34'> 34</a>         parse_route_from_not_step( route_id )
</pre></code><code title='Line 35, lib/parsing/parse.rb'><pre><a name='35'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/lib/parsing/parse.rb#L35'> 35</a>       when "AND"
</pre></code><code title='Line 36, lib/parsing/parse.rb'><pre><a name='36'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/lib/parsing/parse.rb#L36'> 36</a>         parse_route_from_and_step( route_id )
</pre></code><code title='Line 37, lib/parsing/parse.rb'><pre><a name='37'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/lib/parsing/parse.rb#L37'> 37</a>       when "OR"
</pre></code><code title='Line 38, lib/parsing/parse.rb'><pre><a name='38'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/lib/parsing/parse.rb#L38'> 38</a>         parse_route_from_or_step( route_id )
</pre></code><code title='Line 39, lib/parsing/parse.rb'><pre><a name='39'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/lib/parsing/parse.rb#L39'> 39</a>       end
</pre></code><h3>We check the currency of the route.</h3>
<p>Regardless of the type of the source step of the route we know that some routes are not current.</p>
<code title='Line 43, lib/parsing/parse.rb'><pre><a name='43'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/lib/parsing/parse.rb#L43'> 43</a>       parse_route_currency( route_id )
</pre></code><h3>We assign the potential state of any target business step.</h3>
<code title='Line 46, lib/parsing/parse.rb'><pre><a name='46'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/lib/parsing/parse.rb#L46'> 46</a>       assign_potential_business_step_state( route_id )
</pre></code><h3>We continue to traverse the graph by following outbound routes from the target step of this route.</h3>
<p>This forces a depth first traversal of the procedure.</p>
<p>If the target step of the route we&#39;re parsing has outbound routes ...</p>
<code title='Line 51, lib/parsing/parse.rb'><pre><a name='51'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/lib/parsing/parse.rb#L51'> 51</a>       if step_outbound_routes( route_target_step_id( route_id ) )
</pre></code><p>... for each outbound route from the target step of the route ...</p>
<code title='Line 54, lib/parsing/parse.rb'><pre><a name='54'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/lib/parsing/parse.rb#L54'> 54</a>         step_outbound_routes( route_target_step_id( route_id ) ).each do |outbound_route_id|
</pre></code><p>... unless that route has already been parsed ...</p>
<code title='Line 57, lib/parsing/parse.rb'><pre><a name='57'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/lib/parsing/parse.rb#L57'> 57</a>           unless route_parsed_attribute( outbound_route_id ) == true
</pre></code><p>... we parse the route.</p>
<code title='Line 60, lib/parsing/parse.rb'><pre><a name='60'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/lib/parsing/parse.rb#L60'> 60</a>             parse_route_with_id( outbound_route_id )
</pre></code><code title='Line 61, lib/parsing/parse.rb'><pre><a name='61'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/lib/parsing/parse.rb#L61'> 61</a>           end
</pre></code><code title='Line 62, lib/parsing/parse.rb'><pre><a name='62'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/lib/parsing/parse.rb#L62'> 62</a>         end
</pre></code><code title='Line 63, lib/parsing/parse.rb'><pre><a name='63'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/lib/parsing/parse.rb#L63'> 63</a>       end
</pre></code><code title='Line 64, lib/parsing/parse.rb'><pre><a name='64'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/lib/parsing/parse.rb#L64'> 64</a>     end
</pre></code><code title='Line 65, lib/parsing/parse.rb'><pre><a name='65'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/lib/parsing/parse.rb#L65'> 65</a>   end
</pre></code><code title='Line 66, lib/parsing/parse.rb'><pre><a name='66'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/lib/parsing/parse.rb#L66'> 66</a> end</pre></code></body></html>