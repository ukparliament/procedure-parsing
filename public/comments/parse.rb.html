<!DOCTYPE html>
<html lang="en-GB">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width">
    <link rel="alternate" type="text/markdown" href="parse.rb.md">
    <style>
      body {
        max-width: 40rem;
        margin: auto;
        padding: 2rem 1rem;
        font-family: 'Helvetica Neue','Helvetica', system-ui;
        color: black;
        background-color: white;
      }
      p {line-height: 1.4;}
      code {
      line-height: 1.4;
      color:gray;
      }
      code pre {white-space: pre-wrap; word-break: break-word;}
      code:hover {color:black;}
      h1, h2 {font-weight:normal;}
      a {text-decoration:none;}
      a.githubline {color:gray;font-weight:bold;}
      @media (prefers-color-scheme: dark) {
body {color:white;background-color:black;}
a {text-decoration:underline;color:white;}
}
    </style>
    <title>lib/parsing/parse.rb</title>
  </head>
  <body><p><a href="/procedures/comments">/procedures/comments</a></p><h1>Module containing the main parsing code: creation, initialisation and updating a hash for each route.</h1>
<p>Design notes for the <a href="https://ukparliament.github.io/ontologies/procedure/flowcharts/meta/design-notes/#procedure-maps-with-logic-gates">parsing of a procedure map with logic gates are here</a>.</p>
<code title='Line 3, lib/parsing/parse.rb'><pre><a name='3'  class='githubline' href='https://github.com/fantasticlife/egg-timer/tree/master/lib/parsing/parse.rb#L3'> 3</a> module PARSE
</pre></code><h2>Method to parse a route.</h2>
<p>We pass in the route to be parsed, the source step of that route and the procedure the route is in.</p>
<p>The procedure is passed in to ensure that we only parse routes in that particular procedure.</p>
<p>This is necessary because we may encounter steps that are attached to routes in other procedures.</p>
<code title='Line 9, lib/parsing/parse.rb'><pre><a name='9'  class='githubline' href='https://github.com/fantasticlife/egg-timer/tree/master/lib/parsing/parse.rb#L9'> 9</a>    def parse_route( route, source_step, procedure )
</pre></code><p>A route being parsed as part of the set of routes originating from a start step may have already been parsed, because a route subsequent to one of the routes from the start step may have that start step as its target.</p>
<p>We only wish to parse a route if it has not already been parsed.</p>
<p>Unless this route has been parsed ...</p>
<code title='Line 14, lib/parsing/parse.rb'><pre><a name='14'  class='githubline' href='https://github.com/fantasticlife/egg-timer/tree/master/lib/parsing/parse.rb#L14'> 14</a>     unless @routes[route][:parsed] == true
</pre></code><p>... we increment the parse pass count for this route, ...</p>
<code title='Line 17, lib/parsing/parse.rb'><pre><a name='17'  class='githubline' href='https://github.com/fantasticlife/egg-timer/tree/master/lib/parsing/parse.rb#L17'> 17</a>       parse_pass_count = @routes[route][:parse_pass_count] + 1
</pre></code><p>... update the route hash with that count ...</p>
<code title='Line 20, lib/parsing/parse.rb'><pre><a name='20'  class='githubline' href='https://github.com/fantasticlife/egg-timer/tree/master/lib/parsing/parse.rb#L20'> 20</a>       update_route_hash( route, nil, nil, nil, parse_pass_count, nil, nil, nil, nil )
</pre></code><p>... and increment the total parse pass count.</p>
<code title='Line 23, lib/parsing/parse.rb'><pre><a name='23'  class='githubline' href='https://github.com/fantasticlife/egg-timer/tree/master/lib/parsing/parse.rb#L23'> 23</a>       @parse_pass_count += 1
</pre></code><p>... the route and its attributes are logged.</p>
<code title='Line 26, lib/parsing/parse.rb'><pre><a name='26'  class='githubline' href='https://github.com/fantasticlife/egg-timer/tree/master/lib/parsing/parse.rb#L26'> 26</a>       @parse_log << "Parsing route from #{@routes[route][:source_step_name]} (#{@routes[route][:source_step_type]}) to #{@routes[route][:target_step_name]} (#{@routes[route][:target_step_type]}) [#{@parse_pass_count}/#{@route_count}]."
</pre></code><p>... we get the inbound routes to the source step of the route we&#39;re parsing in this procedure.</p>
<code title='Line 29, lib/parsing/parse.rb'><pre><a name='29'  class='githubline' href='https://github.com/fantasticlife/egg-timer/tree/master/lib/parsing/parse.rb#L29'> 29</a>       inbound_routes = source_step.inbound_routes_in_procedure( procedure )
</pre></code><h3>We check the type of the source step of the route we&#39;re parsing and parse the route accordingly.</h3>
<code title='Line 32, lib/parsing/parse.rb'><pre><a name='32'  class='githubline' href='https://github.com/fantasticlife/egg-timer/tree/master/lib/parsing/parse.rb#L32'> 32</a>       case @routes[route][:source_step_type]
</pre></code><code title='Line 33, lib/parsing/parse.rb'><pre><a name='33'  class='githubline' href='https://github.com/fantasticlife/egg-timer/tree/master/lib/parsing/parse.rb#L33'> 33</a>       when "Business step"
</pre></code><code title='Line 34, lib/parsing/parse.rb'><pre><a name='34'  class='githubline' href='https://github.com/fantasticlife/egg-timer/tree/master/lib/parsing/parse.rb#L34'> 34</a>         parse_route_from_business_step( route, source_step, procedure, inbound_routes )
</pre></code><code title='Line 35, lib/parsing/parse.rb'><pre><a name='35'  class='githubline' href='https://github.com/fantasticlife/egg-timer/tree/master/lib/parsing/parse.rb#L35'> 35</a>       when "Decision"
</pre></code><code title='Line 36, lib/parsing/parse.rb'><pre><a name='36'  class='githubline' href='https://github.com/fantasticlife/egg-timer/tree/master/lib/parsing/parse.rb#L36'> 36</a>         parse_route_from_decision_step( route, source_step, procedure, inbound_routes )
</pre></code><code title='Line 37, lib/parsing/parse.rb'><pre><a name='37'  class='githubline' href='https://github.com/fantasticlife/egg-timer/tree/master/lib/parsing/parse.rb#L37'> 37</a>       when "NOT"
</pre></code><code title='Line 38, lib/parsing/parse.rb'><pre><a name='38'  class='githubline' href='https://github.com/fantasticlife/egg-timer/tree/master/lib/parsing/parse.rb#L38'> 38</a>         parse_route_from_not_step( route, source_step, procedure, inbound_routes )
</pre></code><code title='Line 39, lib/parsing/parse.rb'><pre><a name='39'  class='githubline' href='https://github.com/fantasticlife/egg-timer/tree/master/lib/parsing/parse.rb#L39'> 39</a>       when "AND"
</pre></code><code title='Line 40, lib/parsing/parse.rb'><pre><a name='40'  class='githubline' href='https://github.com/fantasticlife/egg-timer/tree/master/lib/parsing/parse.rb#L40'> 40</a>         parse_route_from_and_step( route, source_step, procedure, inbound_routes )
</pre></code><code title='Line 41, lib/parsing/parse.rb'><pre><a name='41'  class='githubline' href='https://github.com/fantasticlife/egg-timer/tree/master/lib/parsing/parse.rb#L41'> 41</a>       when "OR"
</pre></code><code title='Line 42, lib/parsing/parse.rb'><pre><a name='42'  class='githubline' href='https://github.com/fantasticlife/egg-timer/tree/master/lib/parsing/parse.rb#L42'> 42</a>         parse_route_from_or_step( route, source_step, procedure, inbound_routes )
</pre></code><code title='Line 43, lib/parsing/parse.rb'><pre><a name='43'  class='githubline' href='https://github.com/fantasticlife/egg-timer/tree/master/lib/parsing/parse.rb#L43'> 43</a>       end
</pre></code><h3>We check the currency of the route.</h3>
<p>Regardless of the type of the source step of the route we know that some routes are not current.</p>
<code title='Line 47, lib/parsing/parse.rb'><pre><a name='47'  class='githubline' href='https://github.com/fantasticlife/egg-timer/tree/master/lib/parsing/parse.rb#L47'> 47</a>       parse_route_currency( route )
</pre></code><h3>We assign the potential state of any target business step.</h3>
<code title='Line 50, lib/parsing/parse.rb'><pre><a name='50'  class='githubline' href='https://github.com/fantasticlife/egg-timer/tree/master/lib/parsing/parse.rb#L50'> 50</a>       assign_potential_business_step_state( route)
</pre></code><h3>We continue to traverse the graph by following outbound routes from the target step of this route.</h3>
<p>This forces a depth first traversal of the procedure.</p>
<p>We get the target step of the route we&#39;re parsing.</p>
<code title='Line 56, lib/parsing/parse.rb'><pre><a name='56'  class='githubline' href='https://github.com/fantasticlife/egg-timer/tree/master/lib/parsing/parse.rb#L56'> 56</a>       target_step = route.target_step
</pre></code><p>For each outbound route, in the same procedure, from the target step of the route ...</p>
<code title='Line 59, lib/parsing/parse.rb'><pre><a name='59'  class='githubline' href='https://github.com/fantasticlife/egg-timer/tree/master/lib/parsing/parse.rb#L59'> 59</a>       target_step.outbound_routes_in_procedure( procedure ).each do |outbound_route|
</pre></code><p>... unless that route has already been parsed ...</p>
<code title='Line 62, lib/parsing/parse.rb'><pre><a name='62'  class='githubline' href='https://github.com/fantasticlife/egg-timer/tree/master/lib/parsing/parse.rb#L62'> 62</a>         unless @routes[outbound_route][:parsed] == true
</pre></code><p>... we parse the route.</p>
<code title='Line 65, lib/parsing/parse.rb'><pre><a name='65'  class='githubline' href='https://github.com/fantasticlife/egg-timer/tree/master/lib/parsing/parse.rb#L65'> 65</a>           parse_route( outbound_route, target_step, procedure )
</pre></code><code title='Line 66, lib/parsing/parse.rb'><pre><a name='66'  class='githubline' href='https://github.com/fantasticlife/egg-timer/tree/master/lib/parsing/parse.rb#L66'> 66</a>         end
</pre></code><code title='Line 67, lib/parsing/parse.rb'><pre><a name='67'  class='githubline' href='https://github.com/fantasticlife/egg-timer/tree/master/lib/parsing/parse.rb#L67'> 67</a>       end
</pre></code><code title='Line 68, lib/parsing/parse.rb'><pre><a name='68'  class='githubline' href='https://github.com/fantasticlife/egg-timer/tree/master/lib/parsing/parse.rb#L68'> 68</a>     end
</pre></code><code title='Line 69, lib/parsing/parse.rb'><pre><a name='69'  class='githubline' href='https://github.com/fantasticlife/egg-timer/tree/master/lib/parsing/parse.rb#L69'> 69</a>   end
</pre></code><code title='Line 70, lib/parsing/parse.rb'><pre><a name='70'  class='githubline' href='https://github.com/fantasticlife/egg-timer/tree/master/lib/parsing/parse.rb#L70'> 70</a> end</pre></code></body></html>