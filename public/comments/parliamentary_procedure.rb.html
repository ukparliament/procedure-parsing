<!DOCTYPE html>
<html lang="en-GB">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width">
    <link rel="alternate" type="text/markdown" href="parliamentary_procedure.rb.md">
    <style>
      body {
        max-width: 40rem;
        margin: auto;
        padding: 2rem 1rem;
        font-family: 'Helvetica Neue','Helvetica', system-ui;
        color: black;
        background-color: white;
      }
      p {line-height: 1.4;}
      code {
      line-height: 1.4;
      color:gray;
      }
      code pre {white-space: pre-wrap; word-break: break-word;}
      code:hover {color:black;}
      h1, h2 {font-weight:normal;}
      a {text-decoration:none;}
      a.githubline {color:gray;font-weight:bold;}
      @media (prefers-color-scheme: dark) {
body {color:white;background-color:black;}
a {text-decoration:underline;color:white;}
}
    </style>
    <title>app/models/parliamentary_procedure.rb</title>
  </head>
  <body><p><a href="/procedures/meta/comments">/procedures/meta/comments</a></p><h1>Parliamentary procedure model.</h1>
<p>Table and model renamed from the source schema because Rails reserves the name &#39;procedure&#39;.</p>
<code title='Line 3, app/models/parliamentary_procedure.rb'><pre><a name='3'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L3'> 3</a> class ParliamentaryProcedure < ActiveRecord::Base
</pre></code><p>The procedure_routes table joins parliamentary_procedures to their routes, allowing a route to appear in many procedures and a procedure to have many routes.</p>
<code title='Line 6, app/models/parliamentary_procedure.rb'><pre><a name='6'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L6'> 6</a>   has_many :procedure_routes
</pre></code><p>A procedure may have many routes, through the procedure_routes table.</p>
<code title='Line 9, app/models/parliamentary_procedure.rb'><pre><a name='9'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L9'> 9</a>   has_many :routes, :through => 'procedure_routes'
</pre></code><p>We create an association to the work packages subject to a procedure.</p>
<p>Many work packages may be subject to the same procedure.</p>
<code title='Line 13, app/models/parliamentary_procedure.rb'><pre><a name='13'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L13'> 13</a>   has_many :work_packages
</pre></code><h2>Method to return an array of start steps in a procedure.</h2>
<p>New tables have been added to the database to reflect what we plan to happen with the <a href="https://ukparliament.github.io/ontologies/procedure/procedure-ontology.html#d4e244">step collections</a> work: these place steps into a collection of start steps for a given procedure. Until this work happens, we&#39;ll need to hardcode an array.</p>
<p>This method returns an array of start steps and the name of the type of each step, to save on querying for this later.</p>
<code title='Line 18, app/models/parliamentary_procedure.rb'><pre><a name='18'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L18'> 18</a>   def start_steps
</pre></code><code title='Line 19, app/models/parliamentary_procedure.rb'><pre><a name='19'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L19'> 19</a>     Step.all.select('s.*, st.name as step_type_name' ).joins( 'as s, step_collections as sc, step_collection_types as sct, step_types as st' ).where( 's.id = sc.step_id' ).where( 'sc.step_collection_type_id = sct.id' ).where( 'sct.name = ?', 'Start steps' ).where( 'sc.parliamentary_procedure_id =?', self ).where( 's.step_type_id = st.id' )
</pre></code><code title='Line 20, app/models/parliamentary_procedure.rb'><pre><a name='20'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L20'> 20</a>   end
</pre></code><h2>Method to return all routes which appear in a procedure, together with the name and type of the source step of each route and the name and type of the target step of each route. This saves us having to query for these later.</h2>
<code title='Line 23, app/models/parliamentary_procedure.rb'><pre><a name='23'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L23'> 23</a>   def routes_with_steps
</pre></code><code title='Line 24, app/models/parliamentary_procedure.rb'><pre><a name='24'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L24'> 24</a>     Route.all.select( 'r.*, ss.name as source_step_name, ts.name as target_step_name, sst.name as source_step_type, tst.name as target_step_type' ).joins( 'as r, procedure_routes as pr, steps as ss, steps as ts, step_types as sst, step_types as tst' ).where( 'r.id = pr.route_id' ).where( 'pr.parliamentary_procedure_id = ?', self ).where( 'r.from_step_id = ss.id' ).where( 'r.to_step_id = ts.id' ).where( 'ss.step_type_id = sst.id' ).where( 'ts.step_type_id = tst.id' )
</pre></code><code title='Line 25, app/models/parliamentary_procedure.rb'><pre><a name='25'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L25'> 25</a>   end
</pre></code><h2>Method to return all steps connected to routes in a procedure, each step having a flag to say whether the step is in the Commons, a flag to say whether the step is in the Lords and a flag to say whether the step has been actualised in this work package by one or more business items having a date in the past.</h2>
<code title='Line 28, app/models/parliamentary_procedure.rb'><pre><a name='28'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L28'> 28</a>   def steps_with_actualisations_in_work_package( work_package )
</pre></code><code title='Line 29, app/models/parliamentary_procedure.rb'><pre><a name='29'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L29'> 29</a>     Step.find_by_sql(
</pre></code><code title='Line 30, app/models/parliamentary_procedure.rb'><pre><a name='30'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L30'> 30</a>       "
</pre></code><code title='Line 31, app/models/parliamentary_procedure.rb'><pre><a name='31'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L31'> 31</a>         SELECT s.*, SUM(commons_step.is_commons) AS is_in_commons, SUM(lords_step.is_lords) AS is_in_lords, SUM(actualisations.is_actualised_has_happened) AS is_actualised_has_happened
</pre></code><code title='Line 32, app/models/parliamentary_procedure.rb'><pre><a name='32'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L32'> 32</a>         FROM steps s
</pre></code><code title='Line 34, app/models/parliamentary_procedure.rb'><pre><a name='34'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L34'> 34</a>         /* We know that steps appear in a procedure by virtue of being attached to routes in that procedure, so we join to the routes table ... */
</pre></code><code title='Line 35, app/models/parliamentary_procedure.rb'><pre><a name='35'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L35'> 35</a>         INNER JOIN routes r
</pre></code><code title='Line 37, app/models/parliamentary_procedure.rb'><pre><a name='37'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L37'> 37</a>         /* We know that all steps in a procedure have an inbound route and that some don't have an outbound route, so we only bind the step to the to_step_id of a route. */
</pre></code><code title='Line 38, app/models/parliamentary_procedure.rb'><pre><a name='38'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L38'> 38</a>           ON r.to_step_id = s.id
</pre></code><code title='Line 40, app/models/parliamentary_procedure.rb'><pre><a name='40'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L40'> 40</a>         /* We join to the procedure_routes table, using the route_id ... */
</pre></code><code title='Line 41, app/models/parliamentary_procedure.rb'><pre><a name='41'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L41'> 41</a>         INNER JOIN procedure_routes pr
</pre></code><code title='Line 42, app/models/parliamentary_procedure.rb'><pre><a name='42'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L42'> 42</a>         	ON pr.route_id = r.id
</pre></code><code title='Line 44, app/models/parliamentary_procedure.rb'><pre><a name='44'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L44'> 44</a>           /* ... ensuring we only get routes in this procedure. */
</pre></code><code title='Line 45, app/models/parliamentary_procedure.rb'><pre><a name='45'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L45'> 45</a>         	AND pr.parliamentary_procedure_id = #{self.id}
</pre></code><code title='Line 47, app/models/parliamentary_procedure.rb'><pre><a name='47'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L47'> 47</a>         /* We know that a step may be in one or both Houses - or none - via the house_steps table, so we left join to the house_steps table twice. */
</pre></code><code title='Line 48, app/models/parliamentary_procedure.rb'><pre><a name='48'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L48'> 48</a>         /* The left join ensures that the outer step query returns records for steps that are not in the House we're querying for: ... */
</pre></code><code title='Line 50, app/models/parliamentary_procedure.rb'><pre><a name='50'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L50'> 50</a>         /* ... once to check if the step is in the Commons */
</pre></code><code title='Line 51, app/models/parliamentary_procedure.rb'><pre><a name='51'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L51'> 51</a>         LEFT JOIN
</pre></code><code title='Line 52, app/models/parliamentary_procedure.rb'><pre><a name='52'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L52'> 52</a>           (
</pre></code><code title='Line 53, app/models/parliamentary_procedure.rb'><pre><a name='53'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L53'> 53</a>             SELECT 1 as is_commons, hs.step_id
</pre></code><code title='Line 54, app/models/parliamentary_procedure.rb'><pre><a name='54'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L54'> 54</a>             FROM house_steps hs
</pre></code><code title='Line 55, app/models/parliamentary_procedure.rb'><pre><a name='55'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L55'> 55</a>             WHERE hs.house_id = 1 -- 1 being the ID of the Commons.
</pre></code><code title='Line 56, app/models/parliamentary_procedure.rb'><pre><a name='56'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L56'> 56</a>           ) commons_step
</pre></code><code title='Line 57, app/models/parliamentary_procedure.rb'><pre><a name='57'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L57'> 57</a>           ON s.id = commons_step.step_id
</pre></code><code title='Line 59, app/models/parliamentary_procedure.rb'><pre><a name='59'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L59'> 59</a>         /* ... and once to check if the step is in the Lords. */
</pre></code><code title='Line 60, app/models/parliamentary_procedure.rb'><pre><a name='60'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L60'> 60</a>         LEFT JOIN
</pre></code><code title='Line 61, app/models/parliamentary_procedure.rb'><pre><a name='61'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L61'> 61</a>           (
</pre></code><code title='Line 62, app/models/parliamentary_procedure.rb'><pre><a name='62'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L62'> 62</a>             SELECT 1 as is_lords, hs.step_id
</pre></code><code title='Line 63, app/models/parliamentary_procedure.rb'><pre><a name='63'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L63'> 63</a>             FROM house_steps hs
</pre></code><code title='Line 64, app/models/parliamentary_procedure.rb'><pre><a name='64'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L64'> 64</a>             WHERE hs.house_id = 2 -- 2 being the ID of the Lords.
</pre></code><code title='Line 65, app/models/parliamentary_procedure.rb'><pre><a name='65'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L65'> 65</a>           ) lords_step
</pre></code><code title='Line 66, app/models/parliamentary_procedure.rb'><pre><a name='66'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L66'> 66</a>           ON s.id = lords_step.step_id
</pre></code><code title='Line 68, app/models/parliamentary_procedure.rb'><pre><a name='68'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L68'> 68</a>           /* We know that a step may be actualised in a work package by one or more business items having a date in the past, or of today, or having no date. A step may be within a work package, but not actualised. */
</pre></code><code title='Line 69, app/models/parliamentary_procedure.rb'><pre><a name='69'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L69'> 69</a>         /* The left join ensures that the outer step query returns records for steps that have not been actualised with a business item with a date in the past, or of today. */
</pre></code><code title='Line 70, app/models/parliamentary_procedure.rb'><pre><a name='70'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L70'> 70</a>         LEFT JOIN
</pre></code><code title='Line 71, app/models/parliamentary_procedure.rb'><pre><a name='71'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L71'> 71</a>           (
</pre></code><code title='Line 72, app/models/parliamentary_procedure.rb'><pre><a name='72'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L72'> 72</a>             SELECT 1 as is_actualised_has_happened, a.step_id
</pre></code><code title='Line 73, app/models/parliamentary_procedure.rb'><pre><a name='73'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L73'> 73</a>             FROM business_items bi, actualisations a
</pre></code><code title='Line 74, app/models/parliamentary_procedure.rb'><pre><a name='74'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L74'> 74</a>             WHERE bi.id = a.business_item_id
</pre></code><code title='Line 76, app/models/parliamentary_procedure.rb'><pre><a name='76'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L76'> 76</a>              /* We select business items with a date in the past or of today. */
</pre></code><code title='Line 77, app/models/parliamentary_procedure.rb'><pre><a name='77'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L77'> 77</a>             AND bi.date <= CURRENT_DATE
</pre></code><code title='Line 79, app/models/parliamentary_procedure.rb'><pre><a name='79'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L79'> 79</a>             /* We select business items within the specified work package. */
</pre></code><code title='Line 80, app/models/parliamentary_procedure.rb'><pre><a name='80'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L80'> 80</a>             AND bi.work_package_id = #{work_package.id}
</pre></code><code title='Line 81, app/models/parliamentary_procedure.rb'><pre><a name='81'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L81'> 81</a>           ) actualisations
</pre></code><code title='Line 82, app/models/parliamentary_procedure.rb'><pre><a name='82'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L82'> 82</a>           ON s.id = actualisations.step_id
</pre></code><code title='Line 84, app/models/parliamentary_procedure.rb'><pre><a name='84'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L84'> 84</a>           /* We group by the step ID because the same step may be the target step of many routes and we only want to include each step once. */
</pre></code><code title='Line 85, app/models/parliamentary_procedure.rb'><pre><a name='85'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L85'> 85</a>           GROUP BY s.id;
</pre></code><code title='Line 86, app/models/parliamentary_procedure.rb'><pre><a name='86'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L86'> 86</a>       "
</pre></code><code title='Line 87, app/models/parliamentary_procedure.rb'><pre><a name='87'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L87'> 87</a>     )
</pre></code><code title='Line 88, app/models/parliamentary_procedure.rb'><pre><a name='88'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L88'> 88</a>   end
</pre></code><h2>A method to add an ellipsis to a description of a procedure, if the description text is longer than 255 characters.</h2>
<code title='Line 91, app/models/parliamentary_procedure.rb'><pre><a name='91'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L91'> 91</a>   def description_massaged
</pre></code><code title='Line 92, app/models/parliamentary_procedure.rb'><pre><a name='92'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L92'> 92</a>     description.length < 256 ? description : description + " ..."
</pre></code><code title='Line 93, app/models/parliamentary_procedure.rb'><pre><a name='93'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L93'> 93</a>   end
</pre></code><code title='Line 94, app/models/parliamentary_procedure.rb'><pre><a name='94'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L94'> 94</a> end</pre></code></body></html>