<!DOCTYPE html>
<html lang="en-GB">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width">
    <link rel="alternate" type="text/markdown" href="parliamentary_procedure.rb.md">
    <style>
      body {
        max-width: 40rem;
        margin: auto;
        padding: 2rem 1rem;
        font-family: 'Helvetica Neue','Helvetica', system-ui;
        color: black;
        background-color: white;
      }
      p {line-height: 1.4;}
      code {
      line-height: 1.4;
      color:gray;
      }
      code pre {white-space: pre-wrap; word-break: break-word;}
      code:hover {color:black;}
      h1, h2 {font-weight:normal;}
      a {text-decoration:none;}
      a.githubline {color:gray;font-weight:bold;}
      @media (prefers-color-scheme: dark) {
body {color:white;background-color:black;}
a {text-decoration:underline;color:white;}
}
    </style>
    <title>app/models/parliamentary_procedure.rb</title>
  </head>
  <body><p><a href="/procedures/meta/comments">/procedures/meta/comments</a></p><h1>Parliamentary procedure model.</h1>
<p>Table and model renamed from the source schema because Rails reserves the name &#39;procedure&#39;.</p>
<code title='Line 3, app/models/parliamentary_procedure.rb'><pre><a name='3'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L3'> 3</a> class ParliamentaryProcedure < ActiveRecord::Base
</pre></code><p>The procedure_routes table joins parliamentary_procedures to their routes, allowing a route to appear in many procedures and a procedure to have many routes.</p>
<code title='Line 6, app/models/parliamentary_procedure.rb'><pre><a name='6'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L6'> 6</a>   has_many :procedure_routes
</pre></code><p>A procedure may have many routes, through the procedure_routes table.</p>
<code title='Line 9, app/models/parliamentary_procedure.rb'><pre><a name='9'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L9'> 9</a>   has_many :routes, :through => 'procedure_routes'
</pre></code><p>We create an association to the work packages subject to a procedure.</p>
<p>Many work packages may be subject to the same procedure.</p>
<code title='Line 13, app/models/parliamentary_procedure.rb'><pre><a name='13'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L13'> 13</a>   has_many :work_packages
</pre></code><h2>Method to return an array of start steps in a procedure.</h2>
<p>New tables have been added to the database to reflect what we plan to happen with the <a href="https://ukparliament.github.io/ontologies/procedure/procedure-ontology.html#d4e244">step collections</a> work: these place steps into a collection of start steps for a given procedure. Until this work happens, we&#39;ll need to hardcode an array.</p>
<p>This method returns an array of start steps and the name of the type of each step, to save on querying for this later.</p>
<code title='Line 18, app/models/parliamentary_procedure.rb'><pre><a name='18'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L18'> 18</a>   def start_steps
</pre></code><code title='Line 19, app/models/parliamentary_procedure.rb'><pre><a name='19'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L19'> 19</a>     Step.all.select('s.*, st.name as step_type_name' ).joins( 'as s, step_collections as sc, step_collection_types as sct, step_types as st' ).where( 's.id = sc.step_id' ).where( 'sc.step_collection_type_id = sct.id' ).where( 'sct.name = ?', 'Start steps' ).where( 'sc.parliamentary_procedure_id =?', self ).where( 's.step_type_id = st.id' )
</pre></code><code title='Line 20, app/models/parliamentary_procedure.rb'><pre><a name='20'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L20'> 20</a>   end
</pre></code><h2>Method to return all routes which appear in a procedure, together with the name and type of the source step of each route and the name and type of the target step of each route. This saves us having to query for these later.</h2>
<code title='Line 23, app/models/parliamentary_procedure.rb'><pre><a name='23'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L23'> 23</a>   def routes_with_steps
</pre></code><code title='Line 24, app/models/parliamentary_procedure.rb'><pre><a name='24'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L24'> 24</a>     Route.all.select( 'r.*, ss.name as source_step_name, ts.name as target_step_name, sst.name as source_step_type, tst.name as target_step_type' ).joins( 'as r, procedure_routes as pr, steps as ss, steps as ts, step_types as sst, step_types as tst' ).where( 'r.id = pr.route_id' ).where( 'pr.parliamentary_procedure_id = ?', self ).where( 'r.from_step_id = ss.id' ).where( 'r.to_step_id = ts.id' ).where( 'ss.step_type_id = sst.id' ).where( 'ts.step_type_id = tst.id' )
</pre></code><code title='Line 25, app/models/parliamentary_procedure.rb'><pre><a name='25'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L25'> 25</a>   end
</pre></code><h2>Method to return all steps connected to routes in a procedure, each step having:</h2>
<ul>
<li>a flag to say whether the step is in the Commons</li>
</ul>
<ul>
<li>a flag to say whether the step is in the Lords</li>
</ul>
<ul>
<li>a flag to say whether the step has been actualised in this work package by one or more business items having a date in the past</li>
</ul>
<ul>
<li>a flag to say whether the step has been actualised in this work package by one or more business items, regardless of the date of those business items</li>
</ul>
<code title='Line 32, app/models/parliamentary_procedure.rb'><pre><a name='32'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L32'> 32</a>   def steps_with_actualisations_in_work_package( work_package )
</pre></code><code title='Line 33, app/models/parliamentary_procedure.rb'><pre><a name='33'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L33'> 33</a>     Step.find_by_sql(
</pre></code><code title='Line 34, app/models/parliamentary_procedure.rb'><pre><a name='34'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L34'> 34</a>       "
</pre></code><code title='Line 35, app/models/parliamentary_procedure.rb'><pre><a name='35'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L35'> 35</a>         SELECT
</pre></code><code title='Line 36, app/models/parliamentary_procedure.rb'><pre><a name='36'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L36'> 36</a>           s.*,
</pre></code><code title='Line 37, app/models/parliamentary_procedure.rb'><pre><a name='37'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L37'> 37</a>           SUM(commons_step.is_commons) AS is_in_commons, 
</pre></code><code title='Line 38, app/models/parliamentary_procedure.rb'><pre><a name='38'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L38'> 38</a>           SUM(lords_step.is_lords) AS is_in_lords,
</pre></code><code title='Line 39, app/models/parliamentary_procedure.rb'><pre><a name='39'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L39'> 39</a>           SUM(actualisations_has_happened.is_actualised_has_happened) AS is_actualised_has_happened,
</pre></code><code title='Line 40, app/models/parliamentary_procedure.rb'><pre><a name='40'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L40'> 40</a>           COUNT(actualisations_has_happened.actualised_as_happened_count) as actualised_as_happened_count,
</pre></code><code title='Line 41, app/models/parliamentary_procedure.rb'><pre><a name='41'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L41'> 41</a>           SUM(actualisations.is_actualised) AS is_actualised,
</pre></code><code title='Line 42, app/models/parliamentary_procedure.rb'><pre><a name='42'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L42'> 42</a>           SUM(work_package_count.work_package_count) AS work_package_count
</pre></code><code title='Line 43, app/models/parliamentary_procedure.rb'><pre><a name='43'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L43'> 43</a>         FROM steps s
</pre></code><code title='Line 45, app/models/parliamentary_procedure.rb'><pre><a name='45'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L45'> 45</a>         /* We know that steps appear in a procedure by virtue of being attached to routes in that procedure, so we join to the routes table ... */
</pre></code><code title='Line 46, app/models/parliamentary_procedure.rb'><pre><a name='46'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L46'> 46</a>         INNER JOIN routes r
</pre></code><code title='Line 48, app/models/parliamentary_procedure.rb'><pre><a name='48'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L48'> 48</a>         /* We know that all steps in a procedure have an inbound route and that some don't have an outbound route, so we only bind the step to the to_step_id of a route. */
</pre></code><code title='Line 49, app/models/parliamentary_procedure.rb'><pre><a name='49'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L49'> 49</a>           ON r.to_step_id = s.id
</pre></code><code title='Line 51, app/models/parliamentary_procedure.rb'><pre><a name='51'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L51'> 51</a>         /* We join to the procedure_routes table, using the route_id ... */
</pre></code><code title='Line 52, app/models/parliamentary_procedure.rb'><pre><a name='52'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L52'> 52</a>         INNER JOIN procedure_routes pr
</pre></code><code title='Line 53, app/models/parliamentary_procedure.rb'><pre><a name='53'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L53'> 53</a>         	ON pr.route_id = r.id
</pre></code><code title='Line 55, app/models/parliamentary_procedure.rb'><pre><a name='55'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L55'> 55</a>           /* ... ensuring we only get routes in this procedure. */
</pre></code><code title='Line 56, app/models/parliamentary_procedure.rb'><pre><a name='56'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L56'> 56</a>         	AND pr.parliamentary_procedure_id = #{self.id}
</pre></code><code title='Line 58, app/models/parliamentary_procedure.rb'><pre><a name='58'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L58'> 58</a>         /* We know that a step may be in one or both Houses - or none - via the house_steps table, so we left join to the house_steps table twice. */
</pre></code><code title='Line 59, app/models/parliamentary_procedure.rb'><pre><a name='59'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L59'> 59</a>         /* The left join ensures that the outer step query returns records for steps that are not in the House we're querying for: ... */
</pre></code><code title='Line 61, app/models/parliamentary_procedure.rb'><pre><a name='61'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L61'> 61</a>         /* ... once to check if the step is in the Commons */
</pre></code><code title='Line 62, app/models/parliamentary_procedure.rb'><pre><a name='62'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L62'> 62</a>         LEFT JOIN
</pre></code><code title='Line 63, app/models/parliamentary_procedure.rb'><pre><a name='63'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L63'> 63</a>           (
</pre></code><code title='Line 64, app/models/parliamentary_procedure.rb'><pre><a name='64'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L64'> 64</a>             SELECT 1 as is_commons, hs.step_id
</pre></code><code title='Line 65, app/models/parliamentary_procedure.rb'><pre><a name='65'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L65'> 65</a>             FROM house_steps hs
</pre></code><code title='Line 66, app/models/parliamentary_procedure.rb'><pre><a name='66'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L66'> 66</a>             WHERE hs.house_id = 1 -- 1 being the ID of the Commons.
</pre></code><code title='Line 67, app/models/parliamentary_procedure.rb'><pre><a name='67'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L67'> 67</a>             GROUP BY hs.id
</pre></code><code title='Line 68, app/models/parliamentary_procedure.rb'><pre><a name='68'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L68'> 68</a>           ) commons_step
</pre></code><code title='Line 69, app/models/parliamentary_procedure.rb'><pre><a name='69'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L69'> 69</a>           ON s.id = commons_step.step_id
</pre></code><code title='Line 71, app/models/parliamentary_procedure.rb'><pre><a name='71'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L71'> 71</a>         /* ... and once to check if the step is in the Lords. */
</pre></code><code title='Line 72, app/models/parliamentary_procedure.rb'><pre><a name='72'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L72'> 72</a>         LEFT JOIN
</pre></code><code title='Line 73, app/models/parliamentary_procedure.rb'><pre><a name='73'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L73'> 73</a>           (
</pre></code><code title='Line 74, app/models/parliamentary_procedure.rb'><pre><a name='74'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L74'> 74</a>             SELECT 1 as is_lords, hs.step_id
</pre></code><code title='Line 75, app/models/parliamentary_procedure.rb'><pre><a name='75'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L75'> 75</a>             FROM house_steps hs
</pre></code><code title='Line 76, app/models/parliamentary_procedure.rb'><pre><a name='76'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L76'> 76</a>             WHERE hs.house_id = 2 -- 2 being the ID of the Lords.
</pre></code><code title='Line 77, app/models/parliamentary_procedure.rb'><pre><a name='77'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L77'> 77</a>             GROUP BY hs.id
</pre></code><code title='Line 78, app/models/parliamentary_procedure.rb'><pre><a name='78'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L78'> 78</a>           ) lords_step
</pre></code><code title='Line 79, app/models/parliamentary_procedure.rb'><pre><a name='79'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L79'> 79</a>           ON s.id = lords_step.step_id
</pre></code><code title='Line 81, app/models/parliamentary_procedure.rb'><pre><a name='81'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L81'> 81</a>           /* We know that a step may be actualised in a work package by one or more business items having a date in the past, or of today, or having no date. A step may be within a work package, but not actualised. */
</pre></code><code title='Line 82, app/models/parliamentary_procedure.rb'><pre><a name='82'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L82'> 82</a>         /* The left join ensures that the outer step query returns records for steps that have not been actualised with a business item with a date in the past, or of today. */
</pre></code><code title='Line 83, app/models/parliamentary_procedure.rb'><pre><a name='83'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L83'> 83</a>         LEFT JOIN
</pre></code><code title='Line 84, app/models/parliamentary_procedure.rb'><pre><a name='84'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L84'> 84</a>           (
</pre></code><code title='Line 85, app/models/parliamentary_procedure.rb'><pre><a name='85'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L85'> 85</a>             SELECT 1 as is_actualised_has_happened, COUNT(a.id) as actualised_as_happened_count, a.step_id
</pre></code><code title='Line 86, app/models/parliamentary_procedure.rb'><pre><a name='86'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L86'> 86</a>             FROM business_items bi, actualisations a
</pre></code><code title='Line 87, app/models/parliamentary_procedure.rb'><pre><a name='87'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L87'> 87</a>             WHERE bi.id = a.business_item_id
</pre></code><code title='Line 89, app/models/parliamentary_procedure.rb'><pre><a name='89'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L89'> 89</a>             /* We select business items with a date in the past or of today. */
</pre></code><code title='Line 90, app/models/parliamentary_procedure.rb'><pre><a name='90'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L90'> 90</a>             AND bi.date <= CURRENT_DATE
</pre></code><code title='Line 92, app/models/parliamentary_procedure.rb'><pre><a name='92'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L92'> 92</a>             /* We select business items within the specified work package. */
</pre></code><code title='Line 93, app/models/parliamentary_procedure.rb'><pre><a name='93'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L93'> 93</a>             AND bi.work_package_id = #{work_package.id}
</pre></code><code title='Line 95, app/models/parliamentary_procedure.rb'><pre><a name='95'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L95'> 95</a>             /* We group by the ID of the step being actualised. */
</pre></code><code title='Line 96, app/models/parliamentary_procedure.rb'><pre><a name='96'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L96'> 96</a>             GROUP BY a.step_id
</pre></code><code title='Line 98, app/models/parliamentary_procedure.rb'><pre><a name='98'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L98'> 98</a>           ) actualisations_has_happened
</pre></code><code title='Line 99, app/models/parliamentary_procedure.rb'><pre><a name='99'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L99'> 99</a>           ON s.id = actualisations_has_happened.step_id
</pre></code><code title='Line 101, app/models/parliamentary_procedure.rb'><pre><a name='101'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L101'> 101</a>         /* The left join ensures that the outer step query returns records for steps that have not been actualised with a business item, regardless of the date of that business item. */
</pre></code><code title='Line 102, app/models/parliamentary_procedure.rb'><pre><a name='102'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L102'> 102</a>         LEFT JOIN
</pre></code><code title='Line 103, app/models/parliamentary_procedure.rb'><pre><a name='103'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L103'> 103</a>           (
</pre></code><code title='Line 104, app/models/parliamentary_procedure.rb'><pre><a name='104'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L104'> 104</a>             SELECT 1 as is_actualised, a.step_id
</pre></code><code title='Line 105, app/models/parliamentary_procedure.rb'><pre><a name='105'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L105'> 105</a>             FROM business_items bi, actualisations a
</pre></code><code title='Line 106, app/models/parliamentary_procedure.rb'><pre><a name='106'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L106'> 106</a>             WHERE bi.id = a.business_item_id
</pre></code><code title='Line 108, app/models/parliamentary_procedure.rb'><pre><a name='108'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L108'> 108</a>             /* We select business items within the specified work package. */
</pre></code><code title='Line 109, app/models/parliamentary_procedure.rb'><pre><a name='109'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L109'> 109</a>             AND bi.work_package_id = #{work_package.id}
</pre></code><code title='Line 111, app/models/parliamentary_procedure.rb'><pre><a name='111'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L111'> 111</a>             /* We group by the ID of the actualisation. */
</pre></code><code title='Line 112, app/models/parliamentary_procedure.rb'><pre><a name='112'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L112'> 112</a>             GROUP BY a.id
</pre></code><code title='Line 114, app/models/parliamentary_procedure.rb'><pre><a name='114'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L114'> 114</a>           ) actualisations
</pre></code><code title='Line 115, app/models/parliamentary_procedure.rb'><pre><a name='115'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L115'> 115</a>           ON s.id = actualisations.step_id
</pre></code><code title='Line 117, app/models/parliamentary_procedure.rb'><pre><a name='117'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L117'> 117</a>         /* ... we want to get a count of the number of work packages subject to this procedure and where this step has been actualised. */
</pre></code><code title='Line 118, app/models/parliamentary_procedure.rb'><pre><a name='118'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L118'> 118</a>         /* We left join because we want to include zero counts for work packages where this step has not been actualised. */
</pre></code><code title='Line 119, app/models/parliamentary_procedure.rb'><pre><a name='119'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L119'> 119</a>         LEFT JOIN
</pre></code><code title='Line 120, app/models/parliamentary_procedure.rb'><pre><a name='120'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L120'> 120</a>           (
</pre></code><code title='Line 121, app/models/parliamentary_procedure.rb'><pre><a name='121'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L121'> 121</a>             SELECT COUNT(bi.work_package_id) as work_package_count, a.step_id
</pre></code><code title='Line 122, app/models/parliamentary_procedure.rb'><pre><a name='122'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L122'> 122</a>             FROM business_items bi, actualisations a, work_packages wp
</pre></code><code title='Line 124, app/models/parliamentary_procedure.rb'><pre><a name='124'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L124'> 124</a>             /* We only want to include work packages marked as procedure concluded ... */
</pre></code><code title='Line 125, app/models/parliamentary_procedure.rb'><pre><a name='125'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L125'> 125</a>             /* ... so we inner join to work packages with business items actualising a step in the 'End steps' step collection. */
</pre></code><code title='Line 126, app/models/parliamentary_procedure.rb'><pre><a name='126'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L126'> 126</a>             INNER JOIN (
</pre></code><code title='Line 127, app/models/parliamentary_procedure.rb'><pre><a name='127'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L127'> 127</a>               SELECT wp.*
</pre></code><code title='Line 128, app/models/parliamentary_procedure.rb'><pre><a name='128'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L128'> 128</a>               FROM work_packages wp, business_items bi, actualisations a, steps s, step_collections sc, step_collection_types sct
</pre></code><code title='Line 129, app/models/parliamentary_procedure.rb'><pre><a name='129'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L129'> 129</a>               WHERE bi.work_package_id = wp.id
</pre></code><code title='Line 130, app/models/parliamentary_procedure.rb'><pre><a name='130'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L130'> 130</a>               AND bi.id = a.business_item_id
</pre></code><code title='Line 131, app/models/parliamentary_procedure.rb'><pre><a name='131'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L131'> 131</a>               AND wp.parliamentary_procedure_id = #{self.id}
</pre></code><code title='Line 132, app/models/parliamentary_procedure.rb'><pre><a name='132'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L132'> 132</a>               AND bi.id = a.business_item_id
</pre></code><code title='Line 133, app/models/parliamentary_procedure.rb'><pre><a name='133'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L133'> 133</a>               AND a.step_id = s.id
</pre></code><code title='Line 134, app/models/parliamentary_procedure.rb'><pre><a name='134'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L134'> 134</a>               AND s.id = sc.step_id
</pre></code><code title='Line 135, app/models/parliamentary_procedure.rb'><pre><a name='135'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L135'> 135</a>               AND sc.parliamentary_procedure_id = #{self.id}
</pre></code><code title='Line 136, app/models/parliamentary_procedure.rb'><pre><a name='136'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L136'> 136</a>               AND sc.step_collection_type_id = sct.id
</pre></code><code title='Line 137, app/models/parliamentary_procedure.rb'><pre><a name='137'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L137'> 137</a>               AND sct.name = 'End steps'
</pre></code><code title='Line 139, app/models/parliamentary_procedure.rb'><pre><a name='139'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L139'> 139</a>             ) concluded_work_packages
</pre></code><code title='Line 140, app/models/parliamentary_procedure.rb'><pre><a name='140'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L140'> 140</a>             ON concluded_work_packages.id = wp.id
</pre></code><code title='Line 141, app/models/parliamentary_procedure.rb'><pre><a name='141'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L141'> 141</a>             WHERE bi.id = a.business_item_id
</pre></code><code title='Line 142, app/models/parliamentary_procedure.rb'><pre><a name='142'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L142'> 142</a>             AND bi.work_package_id = wp.id
</pre></code><code title='Line 145, app/models/parliamentary_procedure.rb'><pre><a name='145'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L145'> 145</a>             /* We group by the ID of the step being actualised. */
</pre></code><code title='Line 146, app/models/parliamentary_procedure.rb'><pre><a name='146'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L146'> 146</a>             GROUP BY a.step_id
</pre></code><code title='Line 148, app/models/parliamentary_procedure.rb'><pre><a name='148'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L148'> 148</a>           ) work_package_count
</pre></code><code title='Line 149, app/models/parliamentary_procedure.rb'><pre><a name='149'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L149'> 149</a>           ON s.id = work_package_count.step_id
</pre></code><code title='Line 151, app/models/parliamentary_procedure.rb'><pre><a name='151'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L151'> 151</a>         /* We group by the step ID because the same step may be the target step of many routes and we only want to include each step once. */
</pre></code><code title='Line 152, app/models/parliamentary_procedure.rb'><pre><a name='152'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L152'> 152</a>           GROUP BY s.id;
</pre></code><code title='Line 153, app/models/parliamentary_procedure.rb'><pre><a name='153'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L153'> 153</a>       "
</pre></code><code title='Line 154, app/models/parliamentary_procedure.rb'><pre><a name='154'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L154'> 154</a>     )
</pre></code><code title='Line 155, app/models/parliamentary_procedure.rb'><pre><a name='155'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L155'> 155</a>   end
</pre></code><h2>Method to return all business steps connected to routes in a procedure, each step having:</h2>
<ul>
<li>a flag to say whether the step is in the Commons</li>
</ul>
<ul>
<li>a flag to say whether the step is in the Lords</li>
</ul>
<ul>
<li>a count of the number of work packages the step has been actualised in</li>
</ul>
<code title='Line 161, app/models/parliamentary_procedure.rb'><pre><a name='161'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L161'> 161</a>   def steps_with_work_package_count
</pre></code><code title='Line 162, app/models/parliamentary_procedure.rb'><pre><a name='162'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L162'> 162</a>     Step.find_by_sql(
</pre></code><code title='Line 163, app/models/parliamentary_procedure.rb'><pre><a name='163'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L163'> 163</a>       "
</pre></code><code title='Line 164, app/models/parliamentary_procedure.rb'><pre><a name='164'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L164'> 164</a>         SELECT
</pre></code><code title='Line 165, app/models/parliamentary_procedure.rb'><pre><a name='165'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L165'> 165</a>           s.*,
</pre></code><code title='Line 166, app/models/parliamentary_procedure.rb'><pre><a name='166'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L166'> 166</a>           SUM(commons_step.is_commons) AS is_in_commons, 
</pre></code><code title='Line 167, app/models/parliamentary_procedure.rb'><pre><a name='167'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L167'> 167</a>           SUM(lords_step.is_lords) AS is_in_lords,
</pre></code><code title='Line 168, app/models/parliamentary_procedure.rb'><pre><a name='168'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L168'> 168</a>           SUM(work_package_count.work_package_count) AS work_package_count
</pre></code><code title='Line 169, app/models/parliamentary_procedure.rb'><pre><a name='169'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L169'> 169</a>         FROM steps s
</pre></code><code title='Line 171, app/models/parliamentary_procedure.rb'><pre><a name='171'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L171'> 171</a>         /* We know that steps appear in a procedure by virtue of being attached to routes in that procedure, so we join to the routes table ... */
</pre></code><code title='Line 172, app/models/parliamentary_procedure.rb'><pre><a name='172'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L172'> 172</a>         INNER JOIN routes r
</pre></code><code title='Line 174, app/models/parliamentary_procedure.rb'><pre><a name='174'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L174'> 174</a>         /* We know that all steps in a procedure have an inbound route and that some don't have an outbound route, so we only bind the step to the to_step_id of a route. */
</pre></code><code title='Line 175, app/models/parliamentary_procedure.rb'><pre><a name='175'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L175'> 175</a>           ON r.to_step_id = s.id
</pre></code><code title='Line 177, app/models/parliamentary_procedure.rb'><pre><a name='177'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L177'> 177</a>         /* We join to the procedure_routes table, using the route_id ... */
</pre></code><code title='Line 178, app/models/parliamentary_procedure.rb'><pre><a name='178'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L178'> 178</a>         INNER JOIN procedure_routes pr
</pre></code><code title='Line 179, app/models/parliamentary_procedure.rb'><pre><a name='179'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L179'> 179</a>         	ON pr.route_id = r.id
</pre></code><code title='Line 181, app/models/parliamentary_procedure.rb'><pre><a name='181'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L181'> 181</a>           /* ... ensuring we only get routes in this procedure. */
</pre></code><code title='Line 182, app/models/parliamentary_procedure.rb'><pre><a name='182'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L182'> 182</a>         	AND pr.parliamentary_procedure_id = #{self.id}
</pre></code><code title='Line 184, app/models/parliamentary_procedure.rb'><pre><a name='184'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L184'> 184</a>         /* We know that a step may be in one or both Houses - or none - via the house_steps table, so we left join to the house_steps table twice. */
</pre></code><code title='Line 185, app/models/parliamentary_procedure.rb'><pre><a name='185'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L185'> 185</a>         /* The left join ensures that the outer step query returns records for steps that are not in the House we're querying for: ... */
</pre></code><code title='Line 187, app/models/parliamentary_procedure.rb'><pre><a name='187'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L187'> 187</a>         /* ... once to check if the step is in the Commons */
</pre></code><code title='Line 188, app/models/parliamentary_procedure.rb'><pre><a name='188'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L188'> 188</a>         LEFT JOIN
</pre></code><code title='Line 189, app/models/parliamentary_procedure.rb'><pre><a name='189'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L189'> 189</a>           (
</pre></code><code title='Line 190, app/models/parliamentary_procedure.rb'><pre><a name='190'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L190'> 190</a>             SELECT 1 as is_commons, hs.step_id
</pre></code><code title='Line 191, app/models/parliamentary_procedure.rb'><pre><a name='191'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L191'> 191</a>             FROM house_steps hs
</pre></code><code title='Line 192, app/models/parliamentary_procedure.rb'><pre><a name='192'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L192'> 192</a>             WHERE hs.house_id = 1 -- 1 being the ID of the Commons.
</pre></code><code title='Line 193, app/models/parliamentary_procedure.rb'><pre><a name='193'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L193'> 193</a>             GROUP BY hs.id
</pre></code><code title='Line 194, app/models/parliamentary_procedure.rb'><pre><a name='194'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L194'> 194</a>           ) commons_step
</pre></code><code title='Line 195, app/models/parliamentary_procedure.rb'><pre><a name='195'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L195'> 195</a>           ON s.id = commons_step.step_id
</pre></code><code title='Line 197, app/models/parliamentary_procedure.rb'><pre><a name='197'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L197'> 197</a>         /* ... and once to check if the step is in the Lords. */
</pre></code><code title='Line 198, app/models/parliamentary_procedure.rb'><pre><a name='198'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L198'> 198</a>         LEFT JOIN
</pre></code><code title='Line 199, app/models/parliamentary_procedure.rb'><pre><a name='199'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L199'> 199</a>           (
</pre></code><code title='Line 200, app/models/parliamentary_procedure.rb'><pre><a name='200'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L200'> 200</a>             SELECT 1 as is_lords, hs.step_id
</pre></code><code title='Line 201, app/models/parliamentary_procedure.rb'><pre><a name='201'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L201'> 201</a>             FROM house_steps hs
</pre></code><code title='Line 202, app/models/parliamentary_procedure.rb'><pre><a name='202'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L202'> 202</a>             WHERE hs.house_id = 2 -- 2 being the ID of the Lords.
</pre></code><code title='Line 203, app/models/parliamentary_procedure.rb'><pre><a name='203'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L203'> 203</a>             GROUP BY hs.id
</pre></code><code title='Line 204, app/models/parliamentary_procedure.rb'><pre><a name='204'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L204'> 204</a>           ) lords_step
</pre></code><code title='Line 205, app/models/parliamentary_procedure.rb'><pre><a name='205'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L205'> 205</a>           ON s.id = lords_step.step_id
</pre></code><code title='Line 207, app/models/parliamentary_procedure.rb'><pre><a name='207'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L207'> 207</a>         /* ... we want to get a count of the number of work packages subject to this procedure and where this step has been actualised. */
</pre></code><code title='Line 208, app/models/parliamentary_procedure.rb'><pre><a name='208'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L208'> 208</a>         /* We left join because we want to include zero counts for work packages where this step has not been actualised. */
</pre></code><code title='Line 209, app/models/parliamentary_procedure.rb'><pre><a name='209'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L209'> 209</a>         LEFT JOIN
</pre></code><code title='Line 210, app/models/parliamentary_procedure.rb'><pre><a name='210'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L210'> 210</a>           (
</pre></code><code title='Line 211, app/models/parliamentary_procedure.rb'><pre><a name='211'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L211'> 211</a>             SELECT COUNT(bi.work_package_id) as work_package_count, a.step_id
</pre></code><code title='Line 212, app/models/parliamentary_procedure.rb'><pre><a name='212'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L212'> 212</a>             FROM business_items bi, actualisations a, work_packages wp
</pre></code><code title='Line 214, app/models/parliamentary_procedure.rb'><pre><a name='214'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L214'> 214</a>             /* We only want to include work packages marked as procedure concluded ... */
</pre></code><code title='Line 215, app/models/parliamentary_procedure.rb'><pre><a name='215'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L215'> 215</a>             /* ... so we inner join to work packages with business items actualising a step in the 'End steps' step collection. */
</pre></code><code title='Line 216, app/models/parliamentary_procedure.rb'><pre><a name='216'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L216'> 216</a>             INNER JOIN (
</pre></code><code title='Line 217, app/models/parliamentary_procedure.rb'><pre><a name='217'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L217'> 217</a>               SELECT wp.*
</pre></code><code title='Line 218, app/models/parliamentary_procedure.rb'><pre><a name='218'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L218'> 218</a>               FROM work_packages wp, business_items bi, actualisations a, steps s, step_collections sc, step_collection_types sct
</pre></code><code title='Line 219, app/models/parliamentary_procedure.rb'><pre><a name='219'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L219'> 219</a>               WHERE bi.work_package_id = wp.id
</pre></code><code title='Line 220, app/models/parliamentary_procedure.rb'><pre><a name='220'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L220'> 220</a>               AND bi.id = a.business_item_id
</pre></code><code title='Line 221, app/models/parliamentary_procedure.rb'><pre><a name='221'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L221'> 221</a>               AND wp.parliamentary_procedure_id = #{self.id}
</pre></code><code title='Line 222, app/models/parliamentary_procedure.rb'><pre><a name='222'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L222'> 222</a>               AND bi.id = a.business_item_id
</pre></code><code title='Line 223, app/models/parliamentary_procedure.rb'><pre><a name='223'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L223'> 223</a>               AND a.step_id = s.id
</pre></code><code title='Line 224, app/models/parliamentary_procedure.rb'><pre><a name='224'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L224'> 224</a>               AND s.id = sc.step_id
</pre></code><code title='Line 225, app/models/parliamentary_procedure.rb'><pre><a name='225'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L225'> 225</a>               AND sc.parliamentary_procedure_id = #{self.id}
</pre></code><code title='Line 226, app/models/parliamentary_procedure.rb'><pre><a name='226'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L226'> 226</a>               AND sc.step_collection_type_id = sct.id
</pre></code><code title='Line 227, app/models/parliamentary_procedure.rb'><pre><a name='227'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L227'> 227</a>               AND sct.name = 'End steps'
</pre></code><code title='Line 229, app/models/parliamentary_procedure.rb'><pre><a name='229'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L229'> 229</a>             ) concluded_work_packages
</pre></code><code title='Line 230, app/models/parliamentary_procedure.rb'><pre><a name='230'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L230'> 230</a>             ON concluded_work_packages.id = wp.id
</pre></code><code title='Line 231, app/models/parliamentary_procedure.rb'><pre><a name='231'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L231'> 231</a>             WHERE bi.id = a.business_item_id
</pre></code><code title='Line 232, app/models/parliamentary_procedure.rb'><pre><a name='232'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L232'> 232</a>             AND bi.work_package_id = wp.id
</pre></code><code title='Line 235, app/models/parliamentary_procedure.rb'><pre><a name='235'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L235'> 235</a>             /* We group by the ID of the step being actualised. */
</pre></code><code title='Line 236, app/models/parliamentary_procedure.rb'><pre><a name='236'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L236'> 236</a>             GROUP BY a.step_id
</pre></code><code title='Line 238, app/models/parliamentary_procedure.rb'><pre><a name='238'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L238'> 238</a>           ) work_package_count
</pre></code><code title='Line 239, app/models/parliamentary_procedure.rb'><pre><a name='239'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L239'> 239</a>           ON s.id = work_package_count.step_id
</pre></code><code title='Line 241, app/models/parliamentary_procedure.rb'><pre><a name='241'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L241'> 241</a>           /* We only want to include business steps. */
</pre></code><code title='Line 242, app/models/parliamentary_procedure.rb'><pre><a name='242'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L242'> 242</a>           WHERE s.step_type_id = 1
</pre></code><code title='Line 244, app/models/parliamentary_procedure.rb'><pre><a name='244'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L244'> 244</a>           /* We group by the step ID because the same step may be the target step of many routes and we only want to include each step once. */
</pre></code><code title='Line 245, app/models/parliamentary_procedure.rb'><pre><a name='245'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L245'> 245</a>           GROUP BY s.id
</pre></code><code title='Line 246, app/models/parliamentary_procedure.rb'><pre><a name='246'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L246'> 246</a>           ;
</pre></code><code title='Line 247, app/models/parliamentary_procedure.rb'><pre><a name='247'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L247'> 247</a>       "
</pre></code><code title='Line 248, app/models/parliamentary_procedure.rb'><pre><a name='248'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L248'> 248</a>     )
</pre></code><code title='Line 249, app/models/parliamentary_procedure.rb'><pre><a name='249'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L249'> 249</a>   end
</pre></code><code title='Line 251, app/models/parliamentary_procedure.rb'><pre><a name='251'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L251'> 251</a>   def concluded_work_packages
</pre></code><code title='Line 252, app/models/parliamentary_procedure.rb'><pre><a name='252'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L252'> 252</a>     WorkPackage.find_by_sql(
</pre></code><code title='Line 253, app/models/parliamentary_procedure.rb'><pre><a name='253'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L253'> 253</a>     "
</pre></code><code title='Line 254, app/models/parliamentary_procedure.rb'><pre><a name='254'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L254'> 254</a>       SELECT wp.*
</pre></code><code title='Line 255, app/models/parliamentary_procedure.rb'><pre><a name='255'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L255'> 255</a>       FROM work_packages wp
</pre></code><code title='Line 257, app/models/parliamentary_procedure.rb'><pre><a name='257'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L257'> 257</a>       /* We only want to include work packages marked as procedure concluded ... */
</pre></code><code title='Line 258, app/models/parliamentary_procedure.rb'><pre><a name='258'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L258'> 258</a>       /* ... so we inner join to work packages with business items actualising a step in the 'End steps' step collection. */
</pre></code><code title='Line 259, app/models/parliamentary_procedure.rb'><pre><a name='259'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L259'> 259</a>       INNER JOIN (
</pre></code><code title='Line 260, app/models/parliamentary_procedure.rb'><pre><a name='260'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L260'> 260</a>         SELECT wp.id
</pre></code><code title='Line 261, app/models/parliamentary_procedure.rb'><pre><a name='261'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L261'> 261</a>         FROM work_packages wp, business_items bi, actualisations a, steps s, step_collections sc, step_collection_types sct
</pre></code><code title='Line 262, app/models/parliamentary_procedure.rb'><pre><a name='262'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L262'> 262</a>         WHERE wp.id = bi.work_package_id
</pre></code><code title='Line 263, app/models/parliamentary_procedure.rb'><pre><a name='263'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L263'> 263</a>         AND wp.parliamentary_procedure_id = #{self.id}
</pre></code><code title='Line 264, app/models/parliamentary_procedure.rb'><pre><a name='264'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L264'> 264</a>         AND bi.id = a.business_item_id
</pre></code><code title='Line 265, app/models/parliamentary_procedure.rb'><pre><a name='265'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L265'> 265</a>         AND a.step_id = s.id
</pre></code><code title='Line 266, app/models/parliamentary_procedure.rb'><pre><a name='266'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L266'> 266</a>         AND s.id = sc.step_id
</pre></code><code title='Line 267, app/models/parliamentary_procedure.rb'><pre><a name='267'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L267'> 267</a>         AND sc.parliamentary_procedure_id = #{self.id}
</pre></code><code title='Line 268, app/models/parliamentary_procedure.rb'><pre><a name='268'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L268'> 268</a>         AND sc.step_collection_type_id = sct.id
</pre></code><code title='Line 269, app/models/parliamentary_procedure.rb'><pre><a name='269'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L269'> 269</a>         AND sct.name = 'End steps'
</pre></code><code title='Line 270, app/models/parliamentary_procedure.rb'><pre><a name='270'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L270'> 270</a>       ) concluded_work_packages
</pre></code><code title='Line 271, app/models/parliamentary_procedure.rb'><pre><a name='271'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L271'> 271</a>     ON concluded_work_packages.id = wp.id
</pre></code><code title='Line 272, app/models/parliamentary_procedure.rb'><pre><a name='272'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L272'> 272</a>     "
</pre></code><code title='Line 273, app/models/parliamentary_procedure.rb'><pre><a name='273'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L273'> 273</a>     )
</pre></code><code title='Line 274, app/models/parliamentary_procedure.rb'><pre><a name='274'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L274'> 274</a>   end
</pre></code><h2>A method to add an ellipsis to a description of a procedure, if the description text is longer than 255 characters.</h2>
<code title='Line 277, app/models/parliamentary_procedure.rb'><pre><a name='277'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L277'> 277</a>   def description_massaged
</pre></code><code title='Line 278, app/models/parliamentary_procedure.rb'><pre><a name='278'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L278'> 278</a>     description.length < 256 ? description : description + " ..."
</pre></code><code title='Line 279, app/models/parliamentary_procedure.rb'><pre><a name='279'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L279'> 279</a>   end
</pre></code><code title='Line 280, app/models/parliamentary_procedure.rb'><pre><a name='280'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L280'> 280</a> end</pre></code></body></html>