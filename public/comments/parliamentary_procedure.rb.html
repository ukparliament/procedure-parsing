<!DOCTYPE html>
<html lang="en-GB">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width">
    <link rel="alternate" type="text/markdown" href="parliamentary_procedure.rb.md">
    <style>
      body {
        max-width: 40rem;
        margin: auto;
        padding: 2rem 1rem;
        font-family: 'Helvetica Neue','Helvetica', system-ui;
        color: black;
        background-color: white;
      }
      p {line-height: 1.4;}
      code {
      line-height: 1.4;
      color:gray;
      }
      code pre {white-space: pre-wrap; word-break: break-word;}
      code:hover {color:black;}
      h1, h2 {font-weight:normal;}
      a {text-decoration:none;}
      a.githubline {color:gray;font-weight:bold;}
      @media (prefers-color-scheme: dark) {
body {color:white;background-color:black;}
a {text-decoration:underline;color:white;}
}
    </style>
    <title>app/models/parliamentary_procedure.rb</title>
  </head>
  <body><p><a href="/procedures/meta/comments">/procedures/meta/comments</a></p><h1>Parliamentary procedure model.</h1>
<p>Renamed from the source schema because Rails reserves the name procedure.</p>
<code title='Line 3, app/models/parliamentary_procedure.rb'><pre><a name='3'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L3'> 3</a> class ParliamentaryProcedure < ActiveRecord::Base
</pre></code><p>We create an association to the routes which appear in a procedure.</p>
<p>A route may appear in one or more procedures, through the procedure_routes table.</p>
<code title='Line 7, app/models/parliamentary_procedure.rb'><pre><a name='7'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L7'> 7</a>   has_many :procedure_routes
</pre></code><code title='Line 8, app/models/parliamentary_procedure.rb'><pre><a name='8'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L8'> 8</a>   has_many :routes, :through => 'procedure_routes'
</pre></code><p>We create an association to the work packages subject to a procedure.</p>
<code title='Line 11, app/models/parliamentary_procedure.rb'><pre><a name='11'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L11'> 11</a>   has_many :work_packages
</pre></code><h2>Method to return an array of start steps in a procedure.</h2>
<p>New tables have been added to the database to reflect what we plan to happen with the step collections work: these place steps into a collection of start steps for a given procedure. Until this work happens, we&#39;ll need to hardcode an array.</p>
<p>This method returns an array of start steps and the name of each stepâ€™s type, to save on querying for this later.</p>
<code title='Line 16, app/models/parliamentary_procedure.rb'><pre><a name='16'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L16'> 16</a>   def start_steps
</pre></code><code title='Line 17, app/models/parliamentary_procedure.rb'><pre><a name='17'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L17'> 17</a>     Step.all.select('s.*, st.name as step_type_name' ).joins( 'as s, step_collections as sc, step_collection_types as sct, step_types as st' ).where( 's.id = sc.step_id' ).where( 'sc.step_collection_type_id = sct.id' ).where( 'sct.name = ?', 'Start steps' ).where( 'sc.parliamentary_procedure_id =?', self ).where( 's.step_type_id = st.id' )
</pre></code><code title='Line 18, app/models/parliamentary_procedure.rb'><pre><a name='18'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L18'> 18</a>   end
</pre></code><h2>Method to return all routes which appear in a procedure, together with the name and type of the source step of each route and the name and type of the target step of each route. This saves us having to query for these later.</h2>
<code title='Line 21, app/models/parliamentary_procedure.rb'><pre><a name='21'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L21'> 21</a>   def routes_with_steps
</pre></code><code title='Line 22, app/models/parliamentary_procedure.rb'><pre><a name='22'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L22'> 22</a>     Route.all.select( 'r.*, ss.name as source_step_name, ts.name as target_step_name, sst.name as source_step_type, tst.name as target_step_type' ).joins( 'as r, procedure_routes as pr, steps as ss, steps as ts, step_types as sst, step_types as tst' ).where( 'r.id = pr.route_id' ).where( 'pr.parliamentary_procedure_id = ?', self ).where( 'r.from_step_id = ss.id' ).where( 'r.to_step_id = ts.id' ).where( 'ss.step_type_id = sst.id' ).where( 'ts.step_type_id = tst.id' )
</pre></code><code title='Line 23, app/models/parliamentary_procedure.rb'><pre><a name='23'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L23'> 23</a>   end
</pre></code><h2>================</h2>
<h2>Method to return all steps connected to routes in a procedure, together with a count of the number of business items having a date in the past or of today actualising each step.</h2>
<p>Todo: query needs work. actualisation_has_happened_count looks incorrect. Suspect it needs to group before left joining but don&#39;t know how to do that.</p>
<code title='Line 29, app/models/parliamentary_procedure.rb'><pre><a name='29'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L29'> 29</a>   def steps_with_actualisations_in_work_package( work_package )
</pre></code><code title='Line 30, app/models/parliamentary_procedure.rb'><pre><a name='30'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L30'> 30</a>     Step.find_by_sql( "select distinct(s.*), count(business_items.id) as actualisation_has_happened_count
</pre></code><code title='Line 31, app/models/parliamentary_procedure.rb'><pre><a name='31'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L31'> 31</a>       from steps s
</pre></code><code title='Line 32, app/models/parliamentary_procedure.rb'><pre><a name='32'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L32'> 32</a>       inner join routes r
</pre></code><code title='Line 33, app/models/parliamentary_procedure.rb'><pre><a name='33'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L33'> 33</a>         on (s.id = r.from_step_id)
</pre></code><code title='Line 34, app/models/parliamentary_procedure.rb'><pre><a name='34'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L34'> 34</a>       inner join procedure_routes pr
</pre></code><code title='Line 35, app/models/parliamentary_procedure.rb'><pre><a name='35'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L35'> 35</a>         on (r.id=pr.route_id
</pre></code><code title='Line 36, app/models/parliamentary_procedure.rb'><pre><a name='36'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L36'> 36</a>         and pr.parliamentary_procedure_id = #{self.id})
</pre></code><code title='Line 37, app/models/parliamentary_procedure.rb'><pre><a name='37'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L37'> 37</a>       left join actualisations
</pre></code><code title='Line 38, app/models/parliamentary_procedure.rb'><pre><a name='38'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L38'> 38</a>         on s.id = actualisations.step_id
</pre></code><code title='Line 39, app/models/parliamentary_procedure.rb'><pre><a name='39'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L39'> 39</a>       left join business_items
</pre></code><code title='Line 40, app/models/parliamentary_procedure.rb'><pre><a name='40'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L40'> 40</a>         on actualisations.business_item_id = business_items.id
</pre></code><code title='Line 41, app/models/parliamentary_procedure.rb'><pre><a name='41'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L41'> 41</a>         and business_items.date <= CURRENT_DATE
</pre></code><code title='Line 42, app/models/parliamentary_procedure.rb'><pre><a name='42'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L42'> 42</a>         and business_items.work_package_id = #{work_package.id}
</pre></code><code title='Line 43, app/models/parliamentary_procedure.rb'><pre><a name='43'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L43'> 43</a>       group by s.id;" 
</pre></code><code title='Line 44, app/models/parliamentary_procedure.rb'><pre><a name='44'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L44'> 44</a>     )
</pre></code><code title='Line 45, app/models/parliamentary_procedure.rb'><pre><a name='45'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L45'> 45</a>   end
</pre></code><p>=========================</p>
<h2>A method to add ellipses to a description of a procedure, if the description is longer than 255 characters.</h2>
<code title='Line 49, app/models/parliamentary_procedure.rb'><pre><a name='49'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L49'> 49</a>   def description_massaged
</pre></code><code title='Line 50, app/models/parliamentary_procedure.rb'><pre><a name='50'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L50'> 50</a>     description.length < 256 ? description : description + " ..."
</pre></code><code title='Line 51, app/models/parliamentary_procedure.rb'><pre><a name='51'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L51'> 51</a>   end
</pre></code><code title='Line 52, app/models/parliamentary_procedure.rb'><pre><a name='52'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L52'> 52</a> end</pre></code></body></html>