<!DOCTYPE html>
<html lang="en-GB">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width">
    <link rel="alternate" type="text/markdown" href="work_package_controller.rb.md">
    <style>
      body {
        max-width: 40rem;
        margin: auto;
        padding: 2rem 1rem;
        font-family: 'Helvetica Neue','Helvetica', system-ui;
        color: black;
        background-color: white;
      }
      p {line-height: 1.4;}
      code {
      line-height: 1.4;
      color:gray;
      }
      code pre {white-space: pre-wrap; word-break: break-word;}
      code:hover {color:black;}
      h1, h2 {font-weight:normal;}
      a {text-decoration:none;}
      a.githubline {color:gray;font-weight:bold;}
      @media (prefers-color-scheme: dark) {
body {color:white;background-color:black;}
a {text-decoration:underline;color:white;}
}
    </style>
    <title>app/controllers/work_package_controller.rb</title>
  </head>
  <body><p><a href="/procedures/meta/comments">/procedures/meta/comments</a></p><p>The main parsing code and the individual parsing rules for source steps types are packaged into separate files.</p>
<p>We require the main parsing code to be loaded ...</p>
<code title='Line 3, app/controllers/work_package_controller.rb'><pre><a name='3'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L3'> 3</a> require "#{Rails.root}/lib/parsing/parse"
</pre></code><p>... together with the code for parsing specific step types ...</p>
<code title='Line 6, app/controllers/work_package_controller.rb'><pre><a name='6'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L6'> 6</a> require "#{Rails.root}/lib/parsing/and_step"
</pre></code><code title='Line 7, app/controllers/work_package_controller.rb'><pre><a name='7'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L7'> 7</a> require "#{Rails.root}/lib/parsing/business_step"
</pre></code><code title='Line 8, app/controllers/work_package_controller.rb'><pre><a name='8'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L8'> 8</a> require "#{Rails.root}/lib/parsing/decision_step"
</pre></code><code title='Line 9, app/controllers/work_package_controller.rb'><pre><a name='9'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L9'> 9</a> require "#{Rails.root}/lib/parsing/not_step"
</pre></code><code title='Line 10, app/controllers/work_package_controller.rb'><pre><a name='10'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L10'> 10</a> require "#{Rails.root}/lib/parsing/or_step"
</pre></code><p>... and the code for storing route attributes, determining route currency and assigning potential step states.</p>
<code title='Line 13, app/controllers/work_package_controller.rb'><pre><a name='13'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L13'> 13</a> require "#{Rails.root}/lib/parsing/route_hash"
</pre></code><code title='Line 14, app/controllers/work_package_controller.rb'><pre><a name='14'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L14'> 14</a> require "#{Rails.root}/lib/parsing/step_hash"
</pre></code><code title='Line 15, app/controllers/work_package_controller.rb'><pre><a name='15'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L15'> 15</a> require "#{Rails.root}/lib/parsing/route_currency"
</pre></code><code title='Line 16, app/controllers/work_package_controller.rb'><pre><a name='16'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L16'> 16</a> require "#{Rails.root}/lib/parsing/assign_potential_business_step_state"
</pre></code><h1>Work package controller</h1>
<code title='Line 19, app/controllers/work_package_controller.rb'><pre><a name='19'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L19'> 19</a> class WorkPackageController < ApplicationController
</pre></code><p>We include code for the main parsing rules ...</p>
<code title='Line 22, app/controllers/work_package_controller.rb'><pre><a name='22'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L22'> 22</a>   include PARSE
</pre></code><p>... together with code for the different styles of parsing according to the type of the source step ...</p>
<code title='Line 25, app/controllers/work_package_controller.rb'><pre><a name='25'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L25'> 25</a>   include PARSE_BUSINESS_STEP
</pre></code><code title='Line 26, app/controllers/work_package_controller.rb'><pre><a name='26'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L26'> 26</a>   include PARSE_DECISION_STEP
</pre></code><code title='Line 27, app/controllers/work_package_controller.rb'><pre><a name='27'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L27'> 27</a>   include PARSE_NOT_STEP
</pre></code><code title='Line 28, app/controllers/work_package_controller.rb'><pre><a name='28'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L28'> 28</a>   include PARSE_AND_STEP
</pre></code><code title='Line 29, app/controllers/work_package_controller.rb'><pre><a name='29'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L29'> 29</a>   include PARSE_OR_STEP
</pre></code><p>... and the code for storing route attributes, determining route currency and assigning potential step states.</p>
<code title='Line 32, app/controllers/work_package_controller.rb'><pre><a name='32'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L32'> 32</a>   include PARSE_ROUTE_HASH
</pre></code><code title='Line 33, app/controllers/work_package_controller.rb'><pre><a name='33'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L33'> 33</a>   include PARSE_STEP_HASH
</pre></code><code title='Line 34, app/controllers/work_package_controller.rb'><pre><a name='34'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L34'> 34</a>   include PARSE_ROUTE_CURRENCY
</pre></code><code title='Line 35, app/controllers/work_package_controller.rb'><pre><a name='35'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L35'> 35</a>   include PARSE_ASSIGN_POTENTIAL_BUSINESS_STEP_STATE
</pre></code><code title='Line 37, app/controllers/work_package_controller.rb'><pre><a name='37'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L37'> 37</a>   def show
</pre></code><code title='Line 38, app/controllers/work_package_controller.rb'><pre><a name='38'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L38'> 38</a>     parse
</pre></code><code title='Line 40, app/controllers/work_package_controller.rb'><pre><a name='40'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L40'> 40</a>     @business_items_that_have_happened = @work_package.business_items_that_have_happened
</pre></code><code title='Line 41, app/controllers/work_package_controller.rb'><pre><a name='41'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L41'> 41</a>     @business_items_that_are_scheduled_to_happen = @work_package.business_items_that_are_scheduled_to_happen
</pre></code><code title='Line 42, app/controllers/work_package_controller.rb'><pre><a name='42'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L42'> 42</a>     @business_items_unknown = @work_package.business_items_unknown
</pre></code><code title='Line 43, app/controllers/work_package_controller.rb'><pre><a name='43'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L43'> 43</a>   end
</pre></code><code title='Line 45, app/controllers/work_package_controller.rb'><pre><a name='45'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L45'> 45</a>   def log
</pre></code><code title='Line 46, app/controllers/work_package_controller.rb'><pre><a name='46'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L46'> 46</a>     parse
</pre></code><code title='Line 47, app/controllers/work_package_controller.rb'><pre><a name='47'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L47'> 47</a>   end
</pre></code><h2>This method attempts to parse a work package subject to a procedure.</h2>
<p>By taking actualised and non-actualised business steps and parsing the logical procedure map, we aim to determine business steps that may happen, should happen or should not happen in the future.</p>
<code title='Line 51, app/controllers/work_package_controller.rb'><pre><a name='51'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L51'> 51</a>   def parse
</pre></code><p>We get the work package we&#39;re attempting to parse.</p>
<code title='Line 54, app/controllers/work_package_controller.rb'><pre><a name='54'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L54'> 54</a>     work_package = params[:work_package]
</pre></code><code title='Line 55, app/controllers/work_package_controller.rb'><pre><a name='55'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L55'> 55</a>     @work_package = WorkPackage.find( work_package )
</pre></code><p>We get the procedure the work package is subject to.</p>
<p>The procedure is stored as an instance variable because we want to report from it later.</p>
<code title='Line 59, app/controllers/work_package_controller.rb'><pre><a name='59'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L59'> 59</a>     @procedure = @work_package.parliamentary_procedure
</pre></code><p>We set the parse pass count to zero.</p>
<p>The parse pass count will be incremented every time we attempt to parse a route.</p>
<p>The parse pass count is created as an instance variable because we want to increment on each parse pass and report from it later.</p>
<code title='Line 64, app/controllers/work_package_controller.rb'><pre><a name='64'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L64'> 64</a>     @parse_pass_count = 0
</pre></code><p>We create an array to log the parsing.</p>
<p>The log is created as an instance variable because we want to write to it and report from it later.</p>
<code title='Line 68, app/controllers/work_package_controller.rb'><pre><a name='68'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L68'> 68</a>     @parse_log = []
</pre></code><p>We write to the log, explaining what we&#39;re attempting to do.</p>
<code title='Line 71, app/controllers/work_package_controller.rb'><pre><a name='71'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L71'> 71</a>     @parse_log << "Attempting to parse work package #{@work_package.id}, subject to the #{@procedure.name.downcase} procedure."
</pre></code><p>Having successfully parsed a route to a business step, we can determine the <a href="https://ukparliament.github.io/ontologies/procedure/flowcharts/meta/design-notes/#potential-states-of-a-business-step">potential state</a> of that business step. The potential state of a business state may be caused to be actualised, allowed to be actualised, not yet actualisable or not now actualisable.</p>
<p>We create a set of arrays to store the target business steps of the routes we successfully parse - each array being named according to the potential state of the target step.</p>
<p>These are created as instance variables because we want to write to them and report from them later.</p>
<code title='Line 76, app/controllers/work_package_controller.rb'><pre><a name='76'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L76'> 76</a>     @caused_steps = []
</pre></code><code title='Line 77, app/controllers/work_package_controller.rb'><pre><a name='77'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L77'> 77</a>     @allowed_steps = []
</pre></code><code title='Line 78, app/controllers/work_package_controller.rb'><pre><a name='78'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L78'> 78</a>     @disallowed_as_yet_steps = []
</pre></code><code title='Line 79, app/controllers/work_package_controller.rb'><pre><a name='79'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L79'> 79</a>     @disallowed_now_steps = []
</pre></code><p>We initialise a hash of additional route attributes: these are attributes used only during the parsing process.</p>
<code title='Line 82, app/controllers/work_package_controller.rb'><pre><a name='82'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L82'> 82</a>     initialise_route_hash( @work_package )
</pre></code><p>We initialise a hash of steps keyed off the step ID together with a hash of IDs of outbound routes from a step and a hash of IDs of inbound routes to a step, also keyed off the step ID.</p>
<code title='Line 85, app/controllers/work_package_controller.rb'><pre><a name='85'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L85'> 85</a>     initialise_step_hashes( @procedure )
</pre></code><p>We get an array of the start steps in the procedure.</p>
<code title='Line 88, app/controllers/work_package_controller.rb'><pre><a name='88'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L88'> 88</a>     start_steps = @procedure.start_steps
</pre></code><p>We loop through the start steps in the procedure ...</p>
<code title='Line 91, app/controllers/work_package_controller.rb'><pre><a name='91'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L91'> 91</a>     start_steps.each do |step|
</pre></code><p>... then loop through the outbound routes of each start step ...</p>
<code title='Line 94, app/controllers/work_package_controller.rb'><pre><a name='94'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L94'> 94</a>       step_outbound_routes( step.id ).each do |route_id|
</pre></code><p>... and parse each of those routes, passing in the ID of the route .</p>
<code title='Line 97, app/controllers/work_package_controller.rb'><pre><a name='97'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L97'> 97</a>         parse_route_with_id( route_id )
</pre></code><code title='Line 98, app/controllers/work_package_controller.rb'><pre><a name='98'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L98'> 98</a>       end
</pre></code><code title='Line 99, app/controllers/work_package_controller.rb'><pre><a name='99'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L99'> 99</a>     end
</pre></code><code title='Line 100, app/controllers/work_package_controller.rb'><pre><a name='100'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L100'> 100</a>   end
</pre></code><code title='Line 101, app/controllers/work_package_controller.rb'><pre><a name='101'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L101'> 101</a> end</pre></code></body></html>