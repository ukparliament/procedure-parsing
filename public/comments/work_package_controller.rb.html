<!DOCTYPE html>
<html lang="en-GB">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width">
    <link rel="alternate" type="text/markdown" href="work_package_controller.rb.md">
    <style>
      body {
        max-width: 40rem;
        margin: auto;
        padding: 2rem 1rem;
        font-family: 'Helvetica Neue','Helvetica', system-ui;
        color: black;
        background-color: white;
      }
      p {line-height: 1.4;}
      code {
      line-height: 1.4;
      color:gray;
      }
      code pre {white-space: pre-wrap; word-break: break-word;}
      code:hover {color:black;}
      h1, h2 {font-weight:normal;}
      a {text-decoration:none;}
      a.githubline {color:gray;font-weight:bold;}
      @media (prefers-color-scheme: dark) {
body {color:white;background-color:black;}
a {text-decoration:underline;color:white;}
}
    </style>
    <title>app/controllers/work_package_controller.rb</title>
  </head>
  <body><p><a href="/procedures/meta/comments">/procedures/meta/comments</a></p><p>The main parsing code and the individual parsing rules for source steps types are packaged into separate files.</p>
<p>We require the main parsing code to be loaded ...</p>
<code title='Line 3, app/controllers/work_package_controller.rb'><pre><a name='3'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L3'> 3</a> require "#{Rails.root}/lib/parsing/parse"
</pre></code><p>... together with the code for parsing specific step types ...</p>
<code title='Line 6, app/controllers/work_package_controller.rb'><pre><a name='6'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L6'> 6</a> require "#{Rails.root}/lib/parsing/and_step"
</pre></code><code title='Line 7, app/controllers/work_package_controller.rb'><pre><a name='7'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L7'> 7</a> require "#{Rails.root}/lib/parsing/business_step"
</pre></code><code title='Line 8, app/controllers/work_package_controller.rb'><pre><a name='8'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L8'> 8</a> require "#{Rails.root}/lib/parsing/decision_step"
</pre></code><code title='Line 9, app/controllers/work_package_controller.rb'><pre><a name='9'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L9'> 9</a> require "#{Rails.root}/lib/parsing/not_step"
</pre></code><code title='Line 10, app/controllers/work_package_controller.rb'><pre><a name='10'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L10'> 10</a> require "#{Rails.root}/lib/parsing/or_step"
</pre></code><p>... and the code for storing route attributes, determining route currency and assigning potential step states.</p>
<code title='Line 13, app/controllers/work_package_controller.rb'><pre><a name='13'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L13'> 13</a> require "#{Rails.root}/lib/parsing/route_hash"
</pre></code><code title='Line 14, app/controllers/work_package_controller.rb'><pre><a name='14'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L14'> 14</a> require "#{Rails.root}/lib/parsing/route_currency"
</pre></code><code title='Line 15, app/controllers/work_package_controller.rb'><pre><a name='15'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L15'> 15</a> require "#{Rails.root}/lib/parsing/assign_potential_business_step_state"
</pre></code><h1>Work package controller</h1>
<code title='Line 18, app/controllers/work_package_controller.rb'><pre><a name='18'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L18'> 18</a> class WorkPackageController < ApplicationController
</pre></code><p>We include code for the main parsing rules ...</p>
<code title='Line 21, app/controllers/work_package_controller.rb'><pre><a name='21'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L21'> 21</a>   include PARSE
</pre></code><p>... together with code for the different styles of parsing according to the type of the source step ...</p>
<code title='Line 24, app/controllers/work_package_controller.rb'><pre><a name='24'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L24'> 24</a>   include PARSE_BUSINESS_STEP
</pre></code><code title='Line 25, app/controllers/work_package_controller.rb'><pre><a name='25'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L25'> 25</a>   include PARSE_DECISION_STEP
</pre></code><code title='Line 26, app/controllers/work_package_controller.rb'><pre><a name='26'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L26'> 26</a>   include PARSE_NOT_STEP
</pre></code><code title='Line 27, app/controllers/work_package_controller.rb'><pre><a name='27'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L27'> 27</a>   include PARSE_AND_STEP
</pre></code><code title='Line 28, app/controllers/work_package_controller.rb'><pre><a name='28'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L28'> 28</a>   include PARSE_OR_STEP
</pre></code><p>... and the code for storing route attributes, determining route currency and assigning potential step states.</p>
<code title='Line 31, app/controllers/work_package_controller.rb'><pre><a name='31'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L31'> 31</a>   include PARSE_ROUTE_HASH
</pre></code><code title='Line 32, app/controllers/work_package_controller.rb'><pre><a name='32'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L32'> 32</a>   include PARSE_ROUTE_CURRENCY
</pre></code><code title='Line 33, app/controllers/work_package_controller.rb'><pre><a name='33'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L33'> 33</a>   include PARSE_ASSIGN_POTENTIAL_BUSINESS_STEP_STATE
</pre></code><code title='Line 35, app/controllers/work_package_controller.rb'><pre><a name='35'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L35'> 35</a>   def show
</pre></code><code title='Line 36, app/controllers/work_package_controller.rb'><pre><a name='36'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L36'> 36</a>     work_package = params[:work_package]
</pre></code><code title='Line 37, app/controllers/work_package_controller.rb'><pre><a name='37'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L37'> 37</a>     @work_package = WorkPackage.find( work_package )
</pre></code><code title='Line 38, app/controllers/work_package_controller.rb'><pre><a name='38'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L38'> 38</a>     parse
</pre></code><code title='Line 39, app/controllers/work_package_controller.rb'><pre><a name='39'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L39'> 39</a>   end
</pre></code><h2>This method attempts to parse a work package subject to a procedure.</h2>
<p>By taking actualised and non-actualised business steps and parsing the logical procedure map, we aim to determine business steps that may happen, should happen or should not happen in the future.</p>
<code title='Line 43, app/controllers/work_package_controller.rb'><pre><a name='43'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L43'> 43</a>   def parse
</pre></code><p>We get the work package we&#39;re attempting to parse.</p>
<code title='Line 46, app/controllers/work_package_controller.rb'><pre><a name='46'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L46'> 46</a>     work_package = params[:work_package]
</pre></code><code title='Line 47, app/controllers/work_package_controller.rb'><pre><a name='47'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L47'> 47</a>     @work_package = WorkPackage.find( work_package )
</pre></code><p>We get the procedure the work package is subject to.</p>
<code title='Line 50, app/controllers/work_package_controller.rb'><pre><a name='50'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L50'> 50</a>     procedure = @work_package.parliamentary_procedure
</pre></code><p>We set the parse pass count to zero.</p>
<p>The parse pass count will be incremented every time we attempt to parse a route.</p>
<p>The parse pass count is created as an instance variable because we want to increment on each parse and report from it later.</p>
<code title='Line 55, app/controllers/work_package_controller.rb'><pre><a name='55'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L55'> 55</a>     @parse_pass_count = 0
</pre></code><p>We create an array to log the parsing.</p>
<p>The log is created as an instance variable because we want to write to it and report from it later.</p>
<code title='Line 59, app/controllers/work_package_controller.rb'><pre><a name='59'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L59'> 59</a>     @parse_log = []
</pre></code><p>We write to the log, explaining what we&#39;re attempting to do.</p>
<code title='Line 62, app/controllers/work_package_controller.rb'><pre><a name='62'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L62'> 62</a>     @parse_log << "Attempting to parse work package #{@work_package.id}, subject to the #{procedure.name.downcase} procedure."
</pre></code><p>Having successfully parsed a route to a business step, we can determine the potential state of that business step. The potential state of a business state may be caused to be actualised, allowed to be actualised, not yet actualisable or not now actualisable.</p>
<p>We create a set of arrays to store the target business steps of the routes we successfully parse - each array being named according to the potential state of the target step.</p>
<p>These are created as instance variables because we want to write to them and report from them later.</p>
<code title='Line 67, app/controllers/work_package_controller.rb'><pre><a name='67'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L67'> 67</a>     @caused_steps = []
</pre></code><code title='Line 68, app/controllers/work_package_controller.rb'><pre><a name='68'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L68'> 68</a>     @allowed_steps = []
</pre></code><code title='Line 69, app/controllers/work_package_controller.rb'><pre><a name='69'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L69'> 69</a>     @disallowed_yet_steps = []
</pre></code><code title='Line 70, app/controllers/work_package_controller.rb'><pre><a name='70'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L70'> 70</a>     @disallowed_now_steps = []
</pre></code><p>We initialise a hash of additional route attributes: these are attributes used only during the parsing process.</p>
<code title='Line 73, app/controllers/work_package_controller.rb'><pre><a name='73'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L73'> 73</a>     initialise_route_hash( @work_package )
</pre></code><p>We get an array of the start steps in the procedure.</p>
<p>The array is created as an instance variable because we want to check it when parsing business steps.</p>
<code title='Line 77, app/controllers/work_package_controller.rb'><pre><a name='77'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L77'> 77</a>     @start_steps = procedure.start_steps
</pre></code><p>We loop through the start steps in the procedure ...</p>
<code title='Line 80, app/controllers/work_package_controller.rb'><pre><a name='80'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L80'> 80</a>     @start_steps.each do |step|
</pre></code><p>... then loop through the outbound routes of each start step ...</p>
<code title='Line 83, app/controllers/work_package_controller.rb'><pre><a name='83'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L83'> 83</a>       step.outbound_routes_in_procedure( procedure ).each do |route|
</pre></code><p>... and parse each of those routes.</p>
<code title='Line 86, app/controllers/work_package_controller.rb'><pre><a name='86'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L86'> 86</a>         parse_route( route, step, procedure )
</pre></code><code title='Line 87, app/controllers/work_package_controller.rb'><pre><a name='87'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L87'> 87</a>       end
</pre></code><code title='Line 88, app/controllers/work_package_controller.rb'><pre><a name='88'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L88'> 88</a>     end
</pre></code><code title='Line 89, app/controllers/work_package_controller.rb'><pre><a name='89'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L89'> 89</a>   end
</pre></code><code title='Line 90, app/controllers/work_package_controller.rb'><pre><a name='90'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L90'> 90</a> end</pre></code></body></html>