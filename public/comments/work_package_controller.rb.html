<!DOCTYPE html>
<html lang="en-GB">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width">
    <link rel="alternate" type="text/markdown" href="work_package_controller.rb.md">
    <style>
      body {
        max-width: 40rem;
        margin: auto;
        padding: 2rem 1rem;
        font-family: 'Helvetica Neue','Helvetica', system-ui;
        color: black;
        background-color: white;
      }
      p {line-height: 1.4;}
      code {
      line-height: 1.4;
      color:gray;
      }
      code pre {white-space: pre-wrap; word-break: break-word;}
      code:hover {color:black;}
      h1, h2 {font-weight:normal;}
      a {text-decoration:none;}
      a.githubline {color:gray;font-weight:bold;}
      @media (prefers-color-scheme: dark) {
body {color:white;background-color:black;}
a {text-decoration:underline;color:white;}
}
    </style>
    <title>app/controllers/work_package_controller.rb</title>
  </head>
  <body><p><a href="/procedures/meta/comments">/procedures/meta/comments</a></p><p>The main parsing code and the individual parsing rules for source steps types are packaged into separate files.</p>
<p>We require the main parsing code to be loaded ...</p>
<code title='Line 3, app/controllers/work_package_controller.rb'><pre><a name='3'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L3'> 3</a> require "#{Rails.root}/lib/parsing/parse"
</pre></code><p>... together with the code for parsing specific step types ...</p>
<code title='Line 6, app/controllers/work_package_controller.rb'><pre><a name='6'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L6'> 6</a> require "#{Rails.root}/lib/parsing/and_step"
</pre></code><code title='Line 7, app/controllers/work_package_controller.rb'><pre><a name='7'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L7'> 7</a> require "#{Rails.root}/lib/parsing/business_step"
</pre></code><code title='Line 8, app/controllers/work_package_controller.rb'><pre><a name='8'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L8'> 8</a> require "#{Rails.root}/lib/parsing/decision_step"
</pre></code><code title='Line 9, app/controllers/work_package_controller.rb'><pre><a name='9'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L9'> 9</a> require "#{Rails.root}/lib/parsing/not_step"
</pre></code><code title='Line 10, app/controllers/work_package_controller.rb'><pre><a name='10'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L10'> 10</a> require "#{Rails.root}/lib/parsing/or_step"
</pre></code><code title='Line 11, app/controllers/work_package_controller.rb'><pre><a name='11'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L11'> 11</a> require "#{Rails.root}/lib/parsing/sum_step"
</pre></code><code title='Line 12, app/controllers/work_package_controller.rb'><pre><a name='12'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L12'> 12</a> require "#{Rails.root}/lib/parsing/increment_step"
</pre></code><code title='Line 13, app/controllers/work_package_controller.rb'><pre><a name='13'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L13'> 13</a> require "#{Rails.root}/lib/parsing/equals_step"
</pre></code><code title='Line 14, app/controllers/work_package_controller.rb'><pre><a name='14'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L14'> 14</a> require "#{Rails.root}/lib/parsing/summation_step"
</pre></code><p>... and the code for storing route attributes, determining route currency and assigning potential step states.</p>
<code title='Line 17, app/controllers/work_package_controller.rb'><pre><a name='17'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L17'> 17</a> require "#{Rails.root}/lib/parsing/route_hash"
</pre></code><code title='Line 18, app/controllers/work_package_controller.rb'><pre><a name='18'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L18'> 18</a> require "#{Rails.root}/lib/parsing/step_hash"
</pre></code><code title='Line 19, app/controllers/work_package_controller.rb'><pre><a name='19'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L19'> 19</a> require "#{Rails.root}/lib/parsing/route_currency"
</pre></code><code title='Line 20, app/controllers/work_package_controller.rb'><pre><a name='20'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L20'> 20</a> require "#{Rails.root}/lib/parsing/assign_potential_business_step_state"
</pre></code><h1>Work package controller</h1>
<code title='Line 23, app/controllers/work_package_controller.rb'><pre><a name='23'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L23'> 23</a> class WorkPackageController < ApplicationController
</pre></code><p>We include code for the main parsing rules ...</p>
<code title='Line 26, app/controllers/work_package_controller.rb'><pre><a name='26'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L26'> 26</a>   include PARSE
</pre></code><p>... together with code for the different styles of parsing according to the type of the source step ...</p>
<code title='Line 29, app/controllers/work_package_controller.rb'><pre><a name='29'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L29'> 29</a>   include PARSE_BUSINESS_STEP
</pre></code><code title='Line 30, app/controllers/work_package_controller.rb'><pre><a name='30'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L30'> 30</a>   include PARSE_DECISION_STEP
</pre></code><code title='Line 31, app/controllers/work_package_controller.rb'><pre><a name='31'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L31'> 31</a>   include PARSE_NOT_STEP
</pre></code><code title='Line 32, app/controllers/work_package_controller.rb'><pre><a name='32'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L32'> 32</a>   include PARSE_AND_STEP
</pre></code><code title='Line 33, app/controllers/work_package_controller.rb'><pre><a name='33'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L33'> 33</a>   include PARSE_OR_STEP
</pre></code><code title='Line 34, app/controllers/work_package_controller.rb'><pre><a name='34'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L34'> 34</a>   include PARSE_SUM_STEP
</pre></code><code title='Line 35, app/controllers/work_package_controller.rb'><pre><a name='35'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L35'> 35</a>   include PARSE_INCREMENT_STEP
</pre></code><code title='Line 36, app/controllers/work_package_controller.rb'><pre><a name='36'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L36'> 36</a>   include PARSE_EQUALS_STEP
</pre></code><code title='Line 37, app/controllers/work_package_controller.rb'><pre><a name='37'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L37'> 37</a>   include PARSE_SUMMATION_STEP
</pre></code><p>... and the code for storing route attributes, determining route currency and assigning potential step states.</p>
<code title='Line 40, app/controllers/work_package_controller.rb'><pre><a name='40'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L40'> 40</a>   include PARSE_ROUTE_HASH
</pre></code><code title='Line 41, app/controllers/work_package_controller.rb'><pre><a name='41'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L41'> 41</a>   include PARSE_STEP_HASH
</pre></code><code title='Line 42, app/controllers/work_package_controller.rb'><pre><a name='42'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L42'> 42</a>   include PARSE_ROUTE_CURRENCY
</pre></code><code title='Line 43, app/controllers/work_package_controller.rb'><pre><a name='43'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L43'> 43</a>   include PARSE_ASSIGN_POTENTIAL_BUSINESS_STEP_STATE
</pre></code><h2>We show the work package including:</h2>
<ul>
<li>steps with a current state of happened, scheduled to happen and actualised with a business item with no date</li>
</ul>
<ul>
<li>steps with a potential state as determined by the parsing code</li>
</ul>
<code title='Line 49, app/controllers/work_package_controller.rb'><pre><a name='49'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L49'> 49</a>   def show
</pre></code><p>We parse the work package, also getting the work package object.</p>
<code title='Line 52, app/controllers/work_package_controller.rb'><pre><a name='52'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L52'> 52</a>     parse
</pre></code><p>We get business steps actualised as having happened, being scheduled to happen or being actualised with no date.</p>
<code title='Line 55, app/controllers/work_package_controller.rb'><pre><a name='55'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L55'> 55</a>     @business_items_that_have_happened = @work_package.business_items_that_have_happened
</pre></code><code title='Line 56, app/controllers/work_package_controller.rb'><pre><a name='56'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L56'> 56</a>     @business_items_that_are_scheduled_to_happen = @work_package.business_items_that_are_scheduled_to_happen
</pre></code><code title='Line 57, app/controllers/work_package_controller.rb'><pre><a name='57'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L57'> 57</a>     @business_items_unknown = @work_package.business_items_unknown
</pre></code><p>We get all concluded work packages subject to this procedure.</p>
<p>This is used to work out the occurrence score of potential steps.</p>
<code title='Line 61, app/controllers/work_package_controller.rb'><pre><a name='61'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L61'> 61</a>     @concluded_work_packages = @procedure.concluded_work_packages
</pre></code><code title='Line 62, app/controllers/work_package_controller.rb'><pre><a name='62'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L62'> 62</a>   end
</pre></code><h2>We display a log of the parse passes.</h2>
<code title='Line 65, app/controllers/work_package_controller.rb'><pre><a name='65'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L65'> 65</a>   def log
</pre></code><code title='Line 66, app/controllers/work_package_controller.rb'><pre><a name='66'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L66'> 66</a>     parse
</pre></code><code title='Line 67, app/controllers/work_package_controller.rb'><pre><a name='67'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L67'> 67</a>   end
</pre></code><h2>We display a visualisation of the parse passes.</h2>
<code title='Line 70, app/controllers/work_package_controller.rb'><pre><a name='70'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L70'> 70</a>   def visualise
</pre></code><code title='Line 71, app/controllers/work_package_controller.rb'><pre><a name='71'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L71'> 71</a>     parse
</pre></code><code title='Line 72, app/controllers/work_package_controller.rb'><pre><a name='72'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L72'> 72</a>   end
</pre></code><h2>This method attempts to parse a work package subject to a procedure.</h2>
<p>By taking actualised and non-actualised business steps and parsing the logical procedure map, we aim to determine business steps that may happen, should happen or should not happen in the future.</p>
<code title='Line 76, app/controllers/work_package_controller.rb'><pre><a name='76'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L76'> 76</a>   def parse
</pre></code><p>We get the work package we&#39;re attempting to parse.</p>
<code title='Line 79, app/controllers/work_package_controller.rb'><pre><a name='79'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L79'> 79</a>     work_package = params[:work_package]
</pre></code><code title='Line 80, app/controllers/work_package_controller.rb'><pre><a name='80'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L80'> 80</a>     @work_package = WorkPackage.find( work_package )
</pre></code><p>We get the procedure the work package is subject to.</p>
<p>The procedure is stored as an instance variable because we want to report from it later.</p>
<code title='Line 84, app/controllers/work_package_controller.rb'><pre><a name='84'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L84'> 84</a>     @procedure = @work_package.parliamentary_procedure
</pre></code><p>We set the parse pass count to zero.</p>
<p>The parse pass count will be incremented every time we attempt to parse a route.</p>
<p>The parse pass count is created as an instance variable because we want to increment on each parse pass and report from it later.</p>
<code title='Line 89, app/controllers/work_package_controller.rb'><pre><a name='89'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L89'> 89</a>     @parse_pass_count = 0
</pre></code><p>We create an array to log the parsing.</p>
<p>The log is created as an instance variable because we want to write to it and report from it later.</p>
<code title='Line 93, app/controllers/work_package_controller.rb'><pre><a name='93'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L93'> 93</a>     @parse_log = []
</pre></code><p>We write to the log, explaining what we&#39;re attempting to do.</p>
<code title='Line 96, app/controllers/work_package_controller.rb'><pre><a name='96'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L96'> 96</a>     @parse_log << "Attempting to parse work package #{@work_package.id}, subject to the #{@procedure.name.downcase} procedure."
</pre></code><p>Having successfully parsed a route to a business step, we can determine the <a href="https://ukparliament.github.io/ontologies/procedure/maps/meta/design-notes/#potential-states-of-a-business-step">potential state</a> of that business step. The potential state of a business state may be caused to be actualised, allowed to be actualised, not yet actualisable or not now actualisable.</p>
<p>We create a set of arrays to store the target business steps of the routes we successfully parse - each array being named according to the potential state of the target step.</p>
<p>These are created as instance variables because we want to write to them and report from them later.</p>
<code title='Line 101, app/controllers/work_package_controller.rb'><pre><a name='101'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L101'> 101</a>     @caused_steps = []
</pre></code><code title='Line 102, app/controllers/work_package_controller.rb'><pre><a name='102'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L102'> 102</a>     @allowed_steps = []
</pre></code><code title='Line 103, app/controllers/work_package_controller.rb'><pre><a name='103'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L103'> 103</a>     @disallowed_as_yet_steps = []
</pre></code><code title='Line 104, app/controllers/work_package_controller.rb'><pre><a name='104'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L104'> 104</a>     @disallowed_now_steps = []
</pre></code><p>We initialise a hash of additional route attributes: these are attributes are used only during the parsing process.</p>
<code title='Line 107, app/controllers/work_package_controller.rb'><pre><a name='107'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L107'> 107</a>     initialise_route_hash( @work_package )
</pre></code><p>We initialise a hash of steps keyed off the step ID together with a hash of IDs of outbound routes from a step and a hash of IDs of inbound routes to a step, also keyed off the step ID.</p>
<code title='Line 110, app/controllers/work_package_controller.rb'><pre><a name='110'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L110'> 110</a>     initialise_step_hashes( @procedure )
</pre></code><p>We get an array of the start steps in the procedure.</p>
<code title='Line 113, app/controllers/work_package_controller.rb'><pre><a name='113'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L113'> 113</a>     start_steps = @procedure.start_steps
</pre></code><p>We loop through the start steps in the procedure ...</p>
<code title='Line 116, app/controllers/work_package_controller.rb'><pre><a name='116'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L116'> 116</a>     start_steps.each do |step|
</pre></code><p>... then loop through the outbound routes of each start step ...</p>
<code title='Line 119, app/controllers/work_package_controller.rb'><pre><a name='119'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L119'> 119</a>       step_outbound_routes( step.id ).each do |route_id|
</pre></code><p>... and parse each of those routes, passing in the ID of the route.</p>
<code title='Line 122, app/controllers/work_package_controller.rb'><pre><a name='122'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L122'> 122</a>         parse_route_with_id( route_id )
</pre></code><code title='Line 123, app/controllers/work_package_controller.rb'><pre><a name='123'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L123'> 123</a>       end
</pre></code><code title='Line 124, app/controllers/work_package_controller.rb'><pre><a name='124'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L124'> 124</a>     end
</pre></code><code title='Line 125, app/controllers/work_package_controller.rb'><pre><a name='125'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L125'> 125</a>   end
</pre></code><code title='Line 126, app/controllers/work_package_controller.rb'><pre><a name='126'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/controllers/work_package_controller.rb#L126'> 126</a> end</pre></code></body></html>