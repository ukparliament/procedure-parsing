<!DOCTYPE html>
<html lang="en-GB">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width">
    <link rel="alternate" type="text/markdown" href="parliamentary_procedure.rb.md">
    <style>
      body {
        max-width: 40rem;
        margin: auto;
        padding: 2rem 1rem;
        font-family: 'Helvetica Neue','Helvetica', system-ui;
        color: black;
        background-color: white;
      }
      p {line-height: 1.4;}
      code {
      line-height: 1.4;
      color:gray;
      }
      code pre {white-space: pre-wrap; word-break: break-word;}
      code:hover {color:black;}
      h1, h2 {font-weight:normal;}
      a {text-decoration:none;}
      a.githubline {color:gray;font-weight:bold;}
      @media (prefers-color-scheme: dark) {
body {color:white;background-color:black;}
a {text-decoration:underline;color:white;}
}
    </style>
    <title>app/models/parliamentary_procedure.rb</title>
  </head>
  <body><p><a href="/procedures/meta/comments">/procedures/meta/comments</a></p><h1>Parliamentary procedure model.</h1>
<p>Table and model renamed from the source schema because Rails reserves the name &#39;procedure&#39;.</p>
<code title='Line 3, app/models/parliamentary_procedure.rb'><pre><a name='3'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L3'> 3</a> class ParliamentaryProcedure < ActiveRecord::Base
</pre></code><p>The procedure_routes table joins parliamentary_procedures to their routes, allowing a route to appear in many procedures and a procedure to have many routes.</p>
<code title='Line 6, app/models/parliamentary_procedure.rb'><pre><a name='6'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L6'> 6</a>   has_many :procedure_routes
</pre></code><p>A procedure may have many routes, through the procedure_routes table.</p>
<code title='Line 9, app/models/parliamentary_procedure.rb'><pre><a name='9'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L9'> 9</a>   has_many :routes, :through => 'procedure_routes'
</pre></code><p>We create an association to the work packages subject to a procedure.</p>
<p>Many work packages may be subject to the same procedure.</p>
<code title='Line 13, app/models/parliamentary_procedure.rb'><pre><a name='13'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L13'> 13</a>   has_many :work_packages
</pre></code><h2>Method to return an array of start steps in a procedure.</h2>
<p>New tables have been added to the database to reflect what we plan to happen with the <a href="https://ukparliament.github.io/ontologies/procedure/procedure-ontology.html#d4e244">step collections</a> work: these place steps into a collection of start steps for a given procedure. Until this work happens, we&#39;ll need to hardcode an array.</p>
<p>This method returns an array of start steps and the name of the type of each step, to save on querying for this later.</p>
<code title='Line 18, app/models/parliamentary_procedure.rb'><pre><a name='18'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L18'> 18</a>   def start_steps
</pre></code><code title='Line 19, app/models/parliamentary_procedure.rb'><pre><a name='19'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L19'> 19</a>     Step.all
</pre></code><code title='Line 20, app/models/parliamentary_procedure.rb'><pre><a name='20'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L20'> 20</a>       .select('s.*, st.name as step_type_name' )
</pre></code><code title='Line 21, app/models/parliamentary_procedure.rb'><pre><a name='21'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L21'> 21</a>       .joins( 'as s, step_collection_memberships as scm, step_collections as sc, step_types as st, procedure_routes as pr, routes as r' )
</pre></code><code title='Line 22, app/models/parliamentary_procedure.rb'><pre><a name='22'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L22'> 22</a>       .where( 's.id = scm.step_id' )
</pre></code><code title='Line 23, app/models/parliamentary_procedure.rb'><pre><a name='23'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L23'> 23</a>       .where( 'scm.step_collection_id = sc.id' )
</pre></code><code title='Line 24, app/models/parliamentary_procedure.rb'><pre><a name='24'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L24'> 24</a>       .where( 'sc.label = ?', 'Start steps' )
</pre></code><code title='Line 25, app/models/parliamentary_procedure.rb'><pre><a name='25'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L25'> 25</a>       .where( 's.step_type_id = st.id' )
</pre></code><code title='Line 26, app/models/parliamentary_procedure.rb'><pre><a name='26'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L26'> 26</a>       .where( 's.id = r.from_step_id' )
</pre></code><code title='Line 27, app/models/parliamentary_procedure.rb'><pre><a name='27'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L27'> 27</a>       .where( 'r.id = pr.route_id' )
</pre></code><code title='Line 28, app/models/parliamentary_procedure.rb'><pre><a name='28'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L28'> 28</a>       .where( 'pr.parliamentary_procedure_id = ?', self)
</pre></code><code title='Line 29, app/models/parliamentary_procedure.rb'><pre><a name='29'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L29'> 29</a>       .group( 's.id, st.name' )
</pre></code><code title='Line 30, app/models/parliamentary_procedure.rb'><pre><a name='30'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L30'> 30</a>   end
</pre></code><h2>Method to return all routes which appear in a procedure, together with the name and type of the source step of each route and the name and type of the target step of each route. This saves us having to query for these later.</h2>
<code title='Line 33, app/models/parliamentary_procedure.rb'><pre><a name='33'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L33'> 33</a>   def routes_with_steps
</pre></code><code title='Line 34, app/models/parliamentary_procedure.rb'><pre><a name='34'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L34'> 34</a>     Route.all.select( 'r.*, ss.name as source_step_name, ts.name as target_step_name, sst.name as source_step_type, tst.name as target_step_type' ).joins( 'as r, procedure_routes as pr, steps as ss, steps as ts, step_types as sst, step_types as tst' ).where( 'r.id = pr.route_id' ).where( 'pr.parliamentary_procedure_id = ?', self ).where( 'r.from_step_id = ss.id' ).where( 'r.to_step_id = ts.id' ).where( 'ss.step_type_id = sst.id' ).where( 'ts.step_type_id = tst.id' )
</pre></code><code title='Line 35, app/models/parliamentary_procedure.rb'><pre><a name='35'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L35'> 35</a>   end
</pre></code><h2>Method to return all steps connected to routes in a procedure, each step having:</h2>
<ul>
<li>a flag to say whether the step is in the Commons</li>
</ul>
<ul>
<li>a flag to say whether the step is in the Lords</li>
</ul>
<ul>
<li>a flag to say whether the step has been actualised in this work package by one or more business items having a date in the past</li>
</ul>
<ul>
<li>a count of the number of actualisations of the step in this work package by one or more business items having a date in the past</li>
</ul>
<ul>
<li>a flag to say whether the step has been actualised in this work package by one or more business items, regardless of the date of those business items</li>
</ul>
<ul>
<li>a count of the number of concluded work packages subject to this procedure with the step being actualised</li>
</ul>
<code title='Line 44, app/models/parliamentary_procedure.rb'><pre><a name='44'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L44'> 44</a>   def steps_with_actualisations_in_work_package( work_package )
</pre></code><code title='Line 45, app/models/parliamentary_procedure.rb'><pre><a name='45'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L45'> 45</a>     Step.find_by_sql(
</pre></code><code title='Line 46, app/models/parliamentary_procedure.rb'><pre><a name='46'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L46'> 46</a>       "
</pre></code><code title='Line 47, app/models/parliamentary_procedure.rb'><pre><a name='47'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L47'> 47</a>         SELECT
</pre></code><code title='Line 48, app/models/parliamentary_procedure.rb'><pre><a name='48'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L48'> 48</a>           s.*,
</pre></code><code title='Line 49, app/models/parliamentary_procedure.rb'><pre><a name='49'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L49'> 49</a>           step_display_depth.display_depth AS display_depth,
</pre></code><code title='Line 50, app/models/parliamentary_procedure.rb'><pre><a name='50'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L50'> 50</a>           SUM(commons_step.is_commons) AS is_in_commons, 
</pre></code><code title='Line 51, app/models/parliamentary_procedure.rb'><pre><a name='51'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L51'> 51</a>           SUM(lords_step.is_lords) AS is_in_lords,
</pre></code><code title='Line 52, app/models/parliamentary_procedure.rb'><pre><a name='52'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L52'> 52</a>           step_type.step_type_name,
</pre></code><code title='Line 53, app/models/parliamentary_procedure.rb'><pre><a name='53'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L53'> 53</a>           SUM(actualisations_has_happened.is_actualised_has_happened) AS is_actualised_has_happened,
</pre></code><code title='Line 54, app/models/parliamentary_procedure.rb'><pre><a name='54'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L54'> 54</a>           COUNT(actualisations_has_happened.actualised_as_happened_count) as actualised_as_happened_count,
</pre></code><code title='Line 55, app/models/parliamentary_procedure.rb'><pre><a name='55'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L55'> 55</a>           SUM(actualisations.is_actualised) AS is_actualised,
</pre></code><code title='Line 56, app/models/parliamentary_procedure.rb'><pre><a name='56'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L56'> 56</a>           COUNT(work_packages.work_package_id) AS work_package_count
</pre></code><code title='Line 57, app/models/parliamentary_procedure.rb'><pre><a name='57'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L57'> 57</a>         FROM steps s
</pre></code><code title='Line 59, app/models/parliamentary_procedure.rb'><pre><a name='59'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L59'> 59</a>         /* We know that steps appear in a procedure by virtue of being attached to routes in that procedure, so we join to the routes table ... */
</pre></code><code title='Line 60, app/models/parliamentary_procedure.rb'><pre><a name='60'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L60'> 60</a>         INNER JOIN routes r
</pre></code><code title='Line 62, app/models/parliamentary_procedure.rb'><pre><a name='62'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L62'> 62</a>         /* We know that all steps in a procedure have an inbound route and that some don't have an outbound route, so we only bind the step to the to_step_id of a route. */
</pre></code><code title='Line 63, app/models/parliamentary_procedure.rb'><pre><a name='63'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L63'> 63</a>           ON r.to_step_id = s.id
</pre></code><code title='Line 65, app/models/parliamentary_procedure.rb'><pre><a name='65'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L65'> 65</a>         /* We join to the procedure_routes table, using the route_id ... */
</pre></code><code title='Line 66, app/models/parliamentary_procedure.rb'><pre><a name='66'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L66'> 66</a>         INNER JOIN procedure_routes pr
</pre></code><code title='Line 67, app/models/parliamentary_procedure.rb'><pre><a name='67'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L67'> 67</a>         	ON pr.route_id = r.id
</pre></code><code title='Line 69, app/models/parliamentary_procedure.rb'><pre><a name='69'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L69'> 69</a>           /* ... ensuring we only get routes in this procedure. */
</pre></code><code title='Line 70, app/models/parliamentary_procedure.rb'><pre><a name='70'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L70'> 70</a>         	AND pr.parliamentary_procedure_id = #{self.id}
</pre></code><code title='Line 72, app/models/parliamentary_procedure.rb'><pre><a name='72'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L72'> 72</a>         /* We know that a step may be in one or both Houses - or none - via the house_steps table, so we left join to the house_steps table twice. */
</pre></code><code title='Line 73, app/models/parliamentary_procedure.rb'><pre><a name='73'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L73'> 73</a>         /* The left join ensures that the outer step query returns records for steps that are not in the House we're querying for: ... */
</pre></code><code title='Line 75, app/models/parliamentary_procedure.rb'><pre><a name='75'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L75'> 75</a>         /* ... once to check if the step is in the Commons */
</pre></code><code title='Line 76, app/models/parliamentary_procedure.rb'><pre><a name='76'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L76'> 76</a>         LEFT JOIN
</pre></code><code title='Line 77, app/models/parliamentary_procedure.rb'><pre><a name='77'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L77'> 77</a>           (
</pre></code><code title='Line 78, app/models/parliamentary_procedure.rb'><pre><a name='78'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L78'> 78</a>             SELECT 1 as is_commons, hs.step_id
</pre></code><code title='Line 79, app/models/parliamentary_procedure.rb'><pre><a name='79'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L79'> 79</a>             FROM house_steps hs
</pre></code><code title='Line 80, app/models/parliamentary_procedure.rb'><pre><a name='80'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L80'> 80</a>             WHERE hs.house_id = 1 -- 1 being the ID of the Commons.
</pre></code><code title='Line 81, app/models/parliamentary_procedure.rb'><pre><a name='81'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L81'> 81</a>             GROUP BY hs.id
</pre></code><code title='Line 82, app/models/parliamentary_procedure.rb'><pre><a name='82'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L82'> 82</a>           ) commons_step
</pre></code><code title='Line 83, app/models/parliamentary_procedure.rb'><pre><a name='83'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L83'> 83</a>           ON s.id = commons_step.step_id
</pre></code><code title='Line 85, app/models/parliamentary_procedure.rb'><pre><a name='85'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L85'> 85</a>         /* ... and once to check if the step is in the Lords. */
</pre></code><code title='Line 86, app/models/parliamentary_procedure.rb'><pre><a name='86'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L86'> 86</a>         LEFT JOIN
</pre></code><code title='Line 87, app/models/parliamentary_procedure.rb'><pre><a name='87'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L87'> 87</a>           (
</pre></code><code title='Line 88, app/models/parliamentary_procedure.rb'><pre><a name='88'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L88'> 88</a>             SELECT 1 as is_lords, hs.step_id
</pre></code><code title='Line 89, app/models/parliamentary_procedure.rb'><pre><a name='89'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L89'> 89</a>             FROM house_steps hs
</pre></code><code title='Line 90, app/models/parliamentary_procedure.rb'><pre><a name='90'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L90'> 90</a>             WHERE hs.house_id = 2 -- 2 being the ID of the Lords.
</pre></code><code title='Line 91, app/models/parliamentary_procedure.rb'><pre><a name='91'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L91'> 91</a>             GROUP BY hs.id
</pre></code><code title='Line 92, app/models/parliamentary_procedure.rb'><pre><a name='92'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L92'> 92</a>           ) lords_step
</pre></code><code title='Line 93, app/models/parliamentary_procedure.rb'><pre><a name='93'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L93'> 93</a>           ON s.id = lords_step.step_id
</pre></code><code title='Line 95, app/models/parliamentary_procedure.rb'><pre><a name='95'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L95'> 95</a>         /* We know that a step may have a depth in a procedure, so we left join to the step_display_depths table. */
</pre></code><code title='Line 96, app/models/parliamentary_procedure.rb'><pre><a name='96'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L96'> 96</a>         LEFT JOIN
</pre></code><code title='Line 97, app/models/parliamentary_procedure.rb'><pre><a name='97'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L97'> 97</a>           (
</pre></code><code title='Line 98, app/models/parliamentary_procedure.rb'><pre><a name='98'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L98'> 98</a>             SELECT sdd.display_depth as display_depth, sdd.step_id
</pre></code><code title='Line 99, app/models/parliamentary_procedure.rb'><pre><a name='99'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L99'> 99</a>             FROM step_display_depths sdd
</pre></code><code title='Line 100, app/models/parliamentary_procedure.rb'><pre><a name='100'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L100'> 100</a>             WHERE sdd.parliamentary_procedure_id = #{self.id}
</pre></code><code title='Line 101, app/models/parliamentary_procedure.rb'><pre><a name='101'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L101'> 101</a>           ) step_display_depth
</pre></code><code title='Line 102, app/models/parliamentary_procedure.rb'><pre><a name='102'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L102'> 102</a>           ON s.id = step_display_depth.step_id
</pre></code><code title='Line 104, app/models/parliamentary_procedure.rb'><pre><a name='104'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L104'> 104</a>         /* We know that a step has a type, so we left join to step types. */
</pre></code><code title='Line 105, app/models/parliamentary_procedure.rb'><pre><a name='105'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L105'> 105</a>         LEFT JOIN
</pre></code><code title='Line 106, app/models/parliamentary_procedure.rb'><pre><a name='106'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L106'> 106</a>           (
</pre></code><code title='Line 107, app/models/parliamentary_procedure.rb'><pre><a name='107'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L107'> 107</a>             SELECT st.id as step_type_id, st.name as step_type_name
</pre></code><code title='Line 108, app/models/parliamentary_procedure.rb'><pre><a name='108'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L108'> 108</a>             FROM step_types st
</pre></code><code title='Line 109, app/models/parliamentary_procedure.rb'><pre><a name='109'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L109'> 109</a>           ) step_type
</pre></code><code title='Line 110, app/models/parliamentary_procedure.rb'><pre><a name='110'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L110'> 110</a>           ON s.step_type_id = step_type.step_type_id
</pre></code><code title='Line 112, app/models/parliamentary_procedure.rb'><pre><a name='112'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L112'> 112</a>           /* We want to get a count of the number of business items with a date in the past, or of today, having actualised a step in this work package. */
</pre></code><code title='Line 113, app/models/parliamentary_procedure.rb'><pre><a name='113'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L113'> 113</a>           /* We know that a step may be actualised in a work package by one or more business items having a date in the past, or of today, or having no date. A step may be within a procedure, but not actualised in a work package subject to that procedure. */
</pre></code><code title='Line 114, app/models/parliamentary_procedure.rb'><pre><a name='114'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L114'> 114</a>         /* The left join ensures that the outer step query returns records for steps that have not been actualised with a business item with a date in the past, or of today. */
</pre></code><code title='Line 115, app/models/parliamentary_procedure.rb'><pre><a name='115'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L115'> 115</a>         LEFT JOIN
</pre></code><code title='Line 116, app/models/parliamentary_procedure.rb'><pre><a name='116'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L116'> 116</a>           (
</pre></code><code title='Line 117, app/models/parliamentary_procedure.rb'><pre><a name='117'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L117'> 117</a>             SELECT 1 as is_actualised_has_happened, COUNT(a.id) as actualised_as_happened_count, a.step_id
</pre></code><code title='Line 118, app/models/parliamentary_procedure.rb'><pre><a name='118'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L118'> 118</a>             FROM business_items bi, actualisations a
</pre></code><code title='Line 119, app/models/parliamentary_procedure.rb'><pre><a name='119'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L119'> 119</a>             WHERE bi.id = a.business_item_id
</pre></code><code title='Line 121, app/models/parliamentary_procedure.rb'><pre><a name='121'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L121'> 121</a>             /* We select business items with a date in the past or of today. */
</pre></code><code title='Line 122, app/models/parliamentary_procedure.rb'><pre><a name='122'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L122'> 122</a>             AND bi.date <= CURRENT_DATE
</pre></code><code title='Line 124, app/models/parliamentary_procedure.rb'><pre><a name='124'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L124'> 124</a>             /* We select business items within the specified work package. */
</pre></code><code title='Line 125, app/models/parliamentary_procedure.rb'><pre><a name='125'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L125'> 125</a>             AND bi.work_package_id = #{work_package.id}
</pre></code><code title='Line 127, app/models/parliamentary_procedure.rb'><pre><a name='127'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L127'> 127</a>             /* We group by the ID of the step being actualised. */
</pre></code><code title='Line 128, app/models/parliamentary_procedure.rb'><pre><a name='128'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L128'> 128</a>             GROUP BY a.step_id
</pre></code><code title='Line 130, app/models/parliamentary_procedure.rb'><pre><a name='130'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L130'> 130</a>           ) actualisations_has_happened
</pre></code><code title='Line 131, app/models/parliamentary_procedure.rb'><pre><a name='131'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L131'> 131</a>           ON s.id = actualisations_has_happened.step_id
</pre></code><code title='Line 133, app/models/parliamentary_procedure.rb'><pre><a name='133'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L133'> 133</a>           /* We want to know if a step has been actualised by a business item in this work package regardless of the date of the business item. */
</pre></code><code title='Line 134, app/models/parliamentary_procedure.rb'><pre><a name='134'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L134'> 134</a>           /* We know that a step may be actualised in a work package by one or more business items having a date in the past, or of today, or having no date. A step may be within a procedure, but not actualised in a work package subject to that procedure. */
</pre></code><code title='Line 135, app/models/parliamentary_procedure.rb'><pre><a name='135'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L135'> 135</a>         /* The left join ensures that the outer step query returns records for steps that have not been actualised with a business item, regardless of the date of that business item. */
</pre></code><code title='Line 136, app/models/parliamentary_procedure.rb'><pre><a name='136'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L136'> 136</a>         LEFT JOIN
</pre></code><code title='Line 137, app/models/parliamentary_procedure.rb'><pre><a name='137'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L137'> 137</a>           (
</pre></code><code title='Line 138, app/models/parliamentary_procedure.rb'><pre><a name='138'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L138'> 138</a>             SELECT 1 as is_actualised, a.step_id
</pre></code><code title='Line 139, app/models/parliamentary_procedure.rb'><pre><a name='139'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L139'> 139</a>             FROM business_items bi, actualisations a
</pre></code><code title='Line 140, app/models/parliamentary_procedure.rb'><pre><a name='140'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L140'> 140</a>             WHERE bi.id = a.business_item_id
</pre></code><code title='Line 142, app/models/parliamentary_procedure.rb'><pre><a name='142'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L142'> 142</a>             /* We select business items within the specified work package. */
</pre></code><code title='Line 143, app/models/parliamentary_procedure.rb'><pre><a name='143'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L143'> 143</a>             AND bi.work_package_id = #{work_package.id}
</pre></code><code title='Line 145, app/models/parliamentary_procedure.rb'><pre><a name='145'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L145'> 145</a>             /* We group by the ID of the actualisation. */
</pre></code><code title='Line 146, app/models/parliamentary_procedure.rb'><pre><a name='146'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L146'> 146</a>             GROUP BY a.id
</pre></code><code title='Line 148, app/models/parliamentary_procedure.rb'><pre><a name='148'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L148'> 148</a>           ) actualisations
</pre></code><code title='Line 149, app/models/parliamentary_procedure.rb'><pre><a name='149'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L149'> 149</a>           ON s.id = actualisations.step_id
</pre></code><code title='Line 151, app/models/parliamentary_procedure.rb'><pre><a name='151'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L151'> 151</a>         /* We want to get a count of the number of concluded work packages subject to this procedure where this step has been actualised. */
</pre></code><code title='Line 152, app/models/parliamentary_procedure.rb'><pre><a name='152'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L152'> 152</a>         /* We left join because we want to include zero counts for work packages where this step has not been actualised. */
</pre></code><code title='Line 153, app/models/parliamentary_procedure.rb'><pre><a name='153'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L153'> 153</a>         LEFT JOIN
</pre></code><code title='Line 154, app/models/parliamentary_procedure.rb'><pre><a name='154'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L154'> 154</a>           (
</pre></code><code title='Line 155, app/models/parliamentary_procedure.rb'><pre><a name='155'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L155'> 155</a>             SELECT wp.id as work_package_id, a1.step_id as counted_step_id
</pre></code><code title='Line 156, app/models/parliamentary_procedure.rb'><pre><a name='156'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L156'> 156</a>             FROM work_packages wp, business_items bi1, actualisations a1, business_items bi2, actualisations a2, steps s, step_collection_memberships scm, step_collections sc
</pre></code><code title='Line 158, app/models/parliamentary_procedure.rb'><pre><a name='158'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L158'> 158</a>             /* We check the step we're interested in has been actualised in this work package. */
</pre></code><code title='Line 159, app/models/parliamentary_procedure.rb'><pre><a name='159'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L159'> 159</a>             WHERE wp.parliamentary_procedure_id = #{self.id}
</pre></code><code title='Line 160, app/models/parliamentary_procedure.rb'><pre><a name='160'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L160'> 160</a>             AND wp.id = bi1.work_package_id
</pre></code><code title='Line 161, app/models/parliamentary_procedure.rb'><pre><a name='161'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L161'> 161</a>             AND bi1.id = a1.business_item_id
</pre></code><code title='Line 163, app/models/parliamentary_procedure.rb'><pre><a name='163'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L163'> 163</a>             /* We check this work package has a business item actualising a step in the step collection of type 'End steps' */
</pre></code><code title='Line 164, app/models/parliamentary_procedure.rb'><pre><a name='164'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L164'> 164</a>             AND wp.id = bi2.work_package_id
</pre></code><code title='Line 165, app/models/parliamentary_procedure.rb'><pre><a name='165'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L165'> 165</a>             AND bi2.id = a2.business_item_id
</pre></code><code title='Line 166, app/models/parliamentary_procedure.rb'><pre><a name='166'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L166'> 166</a>             AND a2.step_id = s.id
</pre></code><code title='Line 167, app/models/parliamentary_procedure.rb'><pre><a name='167'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L167'> 167</a>             AND s.id = scm.step_id
</pre></code><code title='Line 168, app/models/parliamentary_procedure.rb'><pre><a name='168'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L168'> 168</a>             AND scm.step_collection_id = sc.id
</pre></code><code title='Line 169, app/models/parliamentary_procedure.rb'><pre><a name='169'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L169'> 169</a>             AND sc.label = 'End steps'
</pre></code><code title='Line 171, app/models/parliamentary_procedure.rb'><pre><a name='171'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L171'> 171</a>             GROUP BY wp.id, a1.step_id
</pre></code><code title='Line 172, app/models/parliamentary_procedure.rb'><pre><a name='172'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L172'> 172</a>           ) work_packages
</pre></code><code title='Line 173, app/models/parliamentary_procedure.rb'><pre><a name='173'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L173'> 173</a>           ON work_packages.counted_step_id = s.id
</pre></code><code title='Line 175, app/models/parliamentary_procedure.rb'><pre><a name='175'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L175'> 175</a>         /* We group by the step ID because the same step may be the target step of many routes and we only want to include each step once. */
</pre></code><code title='Line 176, app/models/parliamentary_procedure.rb'><pre><a name='176'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L176'> 176</a>         GROUP BY s.id, step_type.step_type_name, step_display_depth.display_depth;
</pre></code><code title='Line 177, app/models/parliamentary_procedure.rb'><pre><a name='177'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L177'> 177</a>       "
</pre></code><code title='Line 178, app/models/parliamentary_procedure.rb'><pre><a name='178'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L178'> 178</a>     )
</pre></code><code title='Line 179, app/models/parliamentary_procedure.rb'><pre><a name='179'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L179'> 179</a>   end
</pre></code><h2>Method to return all business steps connected to routes in a procedure, each step having:</h2>
<ul>
<li>a flag to say whether the step is in the Commons</li>
</ul>
<ul>
<li>a flag to say whether the step is in the Lords</li>
</ul>
<ul>
<li>a count of the number of concluded work packages subject to this procedure the step has been actualised in</li>
</ul>
<p>The number of concluded work packages subject to this procedure the step has been actualised in is used to calculate the occurrence score for this step being taken in a work package subject to this procedure.</p>
<code title='Line 186, app/models/parliamentary_procedure.rb'><pre><a name='186'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L186'> 186</a>   def steps_with_work_package_count
</pre></code><code title='Line 187, app/models/parliamentary_procedure.rb'><pre><a name='187'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L187'> 187</a>     Step.find_by_sql(
</pre></code><code title='Line 188, app/models/parliamentary_procedure.rb'><pre><a name='188'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L188'> 188</a>       "
</pre></code><code title='Line 189, app/models/parliamentary_procedure.rb'><pre><a name='189'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L189'> 189</a>         SELECT
</pre></code><code title='Line 190, app/models/parliamentary_procedure.rb'><pre><a name='190'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L190'> 190</a>           s.*,
</pre></code><code title='Line 191, app/models/parliamentary_procedure.rb'><pre><a name='191'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L191'> 191</a>           SUM(commons_step.is_commons) AS is_in_commons, 
</pre></code><code title='Line 192, app/models/parliamentary_procedure.rb'><pre><a name='192'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L192'> 192</a>           SUM(lords_step.is_lords) AS is_in_lords,
</pre></code><code title='Line 193, app/models/parliamentary_procedure.rb'><pre><a name='193'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L193'> 193</a>           COUNT(work_packages.work_package_id) AS work_package_count
</pre></code><code title='Line 194, app/models/parliamentary_procedure.rb'><pre><a name='194'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L194'> 194</a>         FROM steps s
</pre></code><code title='Line 196, app/models/parliamentary_procedure.rb'><pre><a name='196'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L196'> 196</a>         /* We know that steps appear in a procedure by virtue of being attached to routes in that procedure, so we join to the routes table ... */
</pre></code><code title='Line 197, app/models/parliamentary_procedure.rb'><pre><a name='197'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L197'> 197</a>         INNER JOIN routes r
</pre></code><code title='Line 199, app/models/parliamentary_procedure.rb'><pre><a name='199'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L199'> 199</a>         /* We know that all steps in a procedure have an inbound route and that some don't have an outbound route, so we only bind the step to the to_step_id of a route. */
</pre></code><code title='Line 200, app/models/parliamentary_procedure.rb'><pre><a name='200'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L200'> 200</a>           ON r.to_step_id = s.id
</pre></code><code title='Line 202, app/models/parliamentary_procedure.rb'><pre><a name='202'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L202'> 202</a>         /* We join to the procedure_routes table, using the route_id ... */
</pre></code><code title='Line 203, app/models/parliamentary_procedure.rb'><pre><a name='203'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L203'> 203</a>         INNER JOIN procedure_routes pr
</pre></code><code title='Line 204, app/models/parliamentary_procedure.rb'><pre><a name='204'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L204'> 204</a>         	ON pr.route_id = r.id
</pre></code><code title='Line 206, app/models/parliamentary_procedure.rb'><pre><a name='206'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L206'> 206</a>           /* ... ensuring we only get routes in this procedure. */
</pre></code><code title='Line 207, app/models/parliamentary_procedure.rb'><pre><a name='207'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L207'> 207</a>         	AND pr.parliamentary_procedure_id = #{self.id}
</pre></code><code title='Line 209, app/models/parliamentary_procedure.rb'><pre><a name='209'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L209'> 209</a>         /* We know that a step may be in one or both Houses - or none - via the house_steps table, so we left join to the house_steps table twice. */
</pre></code><code title='Line 210, app/models/parliamentary_procedure.rb'><pre><a name='210'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L210'> 210</a>         /* The left join ensures that the outer step query returns records for steps that are not in the House we're querying for: ... */
</pre></code><code title='Line 212, app/models/parliamentary_procedure.rb'><pre><a name='212'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L212'> 212</a>         /* ... once to check if the step is in the Commons */
</pre></code><code title='Line 213, app/models/parliamentary_procedure.rb'><pre><a name='213'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L213'> 213</a>         LEFT JOIN
</pre></code><code title='Line 214, app/models/parliamentary_procedure.rb'><pre><a name='214'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L214'> 214</a>           (
</pre></code><code title='Line 215, app/models/parliamentary_procedure.rb'><pre><a name='215'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L215'> 215</a>             SELECT 1 as is_commons, hs.step_id
</pre></code><code title='Line 216, app/models/parliamentary_procedure.rb'><pre><a name='216'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L216'> 216</a>             FROM house_steps hs
</pre></code><code title='Line 217, app/models/parliamentary_procedure.rb'><pre><a name='217'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L217'> 217</a>             WHERE hs.house_id = 1 -- 1 being the ID of the Commons.
</pre></code><code title='Line 218, app/models/parliamentary_procedure.rb'><pre><a name='218'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L218'> 218</a>             GROUP BY hs.id
</pre></code><code title='Line 219, app/models/parliamentary_procedure.rb'><pre><a name='219'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L219'> 219</a>           ) commons_step
</pre></code><code title='Line 220, app/models/parliamentary_procedure.rb'><pre><a name='220'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L220'> 220</a>           ON s.id = commons_step.step_id
</pre></code><code title='Line 222, app/models/parliamentary_procedure.rb'><pre><a name='222'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L222'> 222</a>         /* ... and once to check if the step is in the Lords. */
</pre></code><code title='Line 223, app/models/parliamentary_procedure.rb'><pre><a name='223'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L223'> 223</a>         LEFT JOIN
</pre></code><code title='Line 224, app/models/parliamentary_procedure.rb'><pre><a name='224'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L224'> 224</a>           (
</pre></code><code title='Line 225, app/models/parliamentary_procedure.rb'><pre><a name='225'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L225'> 225</a>             SELECT 1 as is_lords, hs.step_id
</pre></code><code title='Line 226, app/models/parliamentary_procedure.rb'><pre><a name='226'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L226'> 226</a>             FROM house_steps hs
</pre></code><code title='Line 227, app/models/parliamentary_procedure.rb'><pre><a name='227'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L227'> 227</a>             WHERE hs.house_id = 2 -- 2 being the ID of the Lords.
</pre></code><code title='Line 228, app/models/parliamentary_procedure.rb'><pre><a name='228'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L228'> 228</a>             GROUP BY hs.id
</pre></code><code title='Line 229, app/models/parliamentary_procedure.rb'><pre><a name='229'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L229'> 229</a>           ) lords_step
</pre></code><code title='Line 230, app/models/parliamentary_procedure.rb'><pre><a name='230'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L230'> 230</a>           ON s.id = lords_step.step_id
</pre></code><code title='Line 232, app/models/parliamentary_procedure.rb'><pre><a name='232'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L232'> 232</a>           /* We want to get a count of the number of concluded work packages subject to this procedure where this step has been actualised. */
</pre></code><code title='Line 233, app/models/parliamentary_procedure.rb'><pre><a name='233'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L233'> 233</a>           /* We left join because we want to include zero counts for work packages where this step has not been actualised. */
</pre></code><code title='Line 234, app/models/parliamentary_procedure.rb'><pre><a name='234'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L234'> 234</a>         LEFT JOIN
</pre></code><code title='Line 235, app/models/parliamentary_procedure.rb'><pre><a name='235'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L235'> 235</a>           (
</pre></code><code title='Line 236, app/models/parliamentary_procedure.rb'><pre><a name='236'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L236'> 236</a>             SELECT wp.id as work_package_id, a1.step_id as counted_step_id
</pre></code><code title='Line 237, app/models/parliamentary_procedure.rb'><pre><a name='237'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L237'> 237</a>             FROM work_packages wp, business_items bi1, actualisations a1, business_items bi2, actualisations a2, steps s, step_collection_memberships scm, step_collections sc
</pre></code><code title='Line 239, app/models/parliamentary_procedure.rb'><pre><a name='239'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L239'> 239</a>             /* We check the step we're interested in has been actualised in this work package. */
</pre></code><code title='Line 240, app/models/parliamentary_procedure.rb'><pre><a name='240'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L240'> 240</a>             WHERE wp.parliamentary_procedure_id = #{self.id}
</pre></code><code title='Line 241, app/models/parliamentary_procedure.rb'><pre><a name='241'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L241'> 241</a>             AND wp.id = bi1.work_package_id
</pre></code><code title='Line 242, app/models/parliamentary_procedure.rb'><pre><a name='242'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L242'> 242</a>             AND bi1.id = a1.business_item_id
</pre></code><code title='Line 244, app/models/parliamentary_procedure.rb'><pre><a name='244'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L244'> 244</a>             /* We check this work package has a business item actualising a step in the step collection of type 'End steps' */
</pre></code><code title='Line 245, app/models/parliamentary_procedure.rb'><pre><a name='245'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L245'> 245</a>             AND wp.id = bi2.work_package_id
</pre></code><code title='Line 246, app/models/parliamentary_procedure.rb'><pre><a name='246'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L246'> 246</a>             AND bi2.id = a2.business_item_id
</pre></code><code title='Line 247, app/models/parliamentary_procedure.rb'><pre><a name='247'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L247'> 247</a>             AND a2.step_id = s.id
</pre></code><code title='Line 248, app/models/parliamentary_procedure.rb'><pre><a name='248'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L248'> 248</a>             AND s.id = scm.step_id
</pre></code><code title='Line 249, app/models/parliamentary_procedure.rb'><pre><a name='249'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L249'> 249</a>             AND scm.step_collection_id = sc.id
</pre></code><code title='Line 250, app/models/parliamentary_procedure.rb'><pre><a name='250'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L250'> 250</a>             AND sc.label = 'End steps'
</pre></code><code title='Line 252, app/models/parliamentary_procedure.rb'><pre><a name='252'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L252'> 252</a>             GROUP BY wp.id, a1.step_id
</pre></code><code title='Line 253, app/models/parliamentary_procedure.rb'><pre><a name='253'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L253'> 253</a>           ) work_packages
</pre></code><code title='Line 254, app/models/parliamentary_procedure.rb'><pre><a name='254'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L254'> 254</a>           ON work_packages.counted_step_id = s.id
</pre></code><code title='Line 256, app/models/parliamentary_procedure.rb'><pre><a name='256'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L256'> 256</a>           /* We only want to include business steps. */
</pre></code><code title='Line 257, app/models/parliamentary_procedure.rb'><pre><a name='257'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L257'> 257</a>           WHERE s.step_type_id = 1
</pre></code><code title='Line 259, app/models/parliamentary_procedure.rb'><pre><a name='259'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L259'> 259</a>           /* We group by the step ID because the same step may be the target step of many routes and we only want to include each step once. */
</pre></code><code title='Line 260, app/models/parliamentary_procedure.rb'><pre><a name='260'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L260'> 260</a>           GROUP BY s.id
</pre></code><code title='Line 261, app/models/parliamentary_procedure.rb'><pre><a name='261'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L261'> 261</a>           ;
</pre></code><code title='Line 262, app/models/parliamentary_procedure.rb'><pre><a name='262'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L262'> 262</a>       "
</pre></code><code title='Line 263, app/models/parliamentary_procedure.rb'><pre><a name='263'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L263'> 263</a>     )
</pre></code><code title='Line 264, app/models/parliamentary_procedure.rb'><pre><a name='264'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L264'> 264</a>   end
</pre></code><h2>Method to return all work packages subject to this procedure marked as procedure concluded.</h2>
<p>This includes both Commons only and bicamerally concluded work packages.</p>
<p>The number of concluded work packages subject to a procedure is used to calculate the occurrence score of a step being taken.</p>
<code title='Line 269, app/models/parliamentary_procedure.rb'><pre><a name='269'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L269'> 269</a>   def concluded_work_packages
</pre></code><code title='Line 270, app/models/parliamentary_procedure.rb'><pre><a name='270'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L270'> 270</a>     WorkPackage.find_by_sql(
</pre></code><code title='Line 271, app/models/parliamentary_procedure.rb'><pre><a name='271'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L271'> 271</a>       "
</pre></code><code title='Line 272, app/models/parliamentary_procedure.rb'><pre><a name='272'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L272'> 272</a>         SELECT wp.*
</pre></code><code title='Line 273, app/models/parliamentary_procedure.rb'><pre><a name='273'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L273'> 273</a>         FROM work_packages wp, business_items bi, actualisations a, steps s, step_collection_memberships scm, step_collections sc
</pre></code><code title='Line 274, app/models/parliamentary_procedure.rb'><pre><a name='274'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L274'> 274</a>         WHERE wp.parliamentary_procedure_id = #{self.id}
</pre></code><code title='Line 275, app/models/parliamentary_procedure.rb'><pre><a name='275'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L275'> 275</a>         AND wp.id = bi.work_package_id
</pre></code><code title='Line 276, app/models/parliamentary_procedure.rb'><pre><a name='276'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L276'> 276</a>         AND bi.id = a.business_item_id
</pre></code><code title='Line 277, app/models/parliamentary_procedure.rb'><pre><a name='277'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L277'> 277</a>         AND a.step_id = s.id
</pre></code><code title='Line 278, app/models/parliamentary_procedure.rb'><pre><a name='278'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L278'> 278</a>         AND s.id = scm.step_id
</pre></code><code title='Line 279, app/models/parliamentary_procedure.rb'><pre><a name='279'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L279'> 279</a>         AND scm.step_collection_id = sc.id
</pre></code><code title='Line 280, app/models/parliamentary_procedure.rb'><pre><a name='280'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L280'> 280</a>         AND sc.label = 'End steps'
</pre></code><code title='Line 281, app/models/parliamentary_procedure.rb'><pre><a name='281'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L281'> 281</a>         GROUP BY wp.id
</pre></code><code title='Line 282, app/models/parliamentary_procedure.rb'><pre><a name='282'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L282'> 282</a>       "
</pre></code><code title='Line 283, app/models/parliamentary_procedure.rb'><pre><a name='283'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L283'> 283</a>     )
</pre></code><code title='Line 284, app/models/parliamentary_procedure.rb'><pre><a name='284'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L284'> 284</a>   end
</pre></code><h2>Method to return all work packages subject to this procedure marked as procedure concluded in both Houses.</h2>
<p>This includes bicamerally concluded work packages only.</p>
<p>The number of concluded work packages subject to a procedure is used to calculate the occurrence score of a step being taken.</p>
<code title='Line 289, app/models/parliamentary_procedure.rb'><pre><a name='289'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L289'> 289</a>   def bicamerally_concluded_work_packages
</pre></code><code title='Line 290, app/models/parliamentary_procedure.rb'><pre><a name='290'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L290'> 290</a>     WorkPackage.find_by_sql(
</pre></code><code title='Line 291, app/models/parliamentary_procedure.rb'><pre><a name='291'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L291'> 291</a>       "
</pre></code><code title='Line 292, app/models/parliamentary_procedure.rb'><pre><a name='292'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L292'> 292</a>         SELECT wp.*
</pre></code><code title='Line 293, app/models/parliamentary_procedure.rb'><pre><a name='293'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L293'> 293</a>         FROM work_packages wp, business_items bi, actualisations a, steps s, step_collection_memberships scm, step_collections sc
</pre></code><code title='Line 294, app/models/parliamentary_procedure.rb'><pre><a name='294'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L294'> 294</a>         WHERE wp.parliamentary_procedure_id = #{self.id}
</pre></code><code title='Line 295, app/models/parliamentary_procedure.rb'><pre><a name='295'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L295'> 295</a>         AND wp.id = bi.work_package_id
</pre></code><code title='Line 296, app/models/parliamentary_procedure.rb'><pre><a name='296'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L296'> 296</a>         AND bi.id = a.business_item_id
</pre></code><code title='Line 297, app/models/parliamentary_procedure.rb'><pre><a name='297'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L297'> 297</a>         AND a.step_id = s.id
</pre></code><code title='Line 298, app/models/parliamentary_procedure.rb'><pre><a name='298'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L298'> 298</a>         AND s.id = scm.step_id
</pre></code><code title='Line 299, app/models/parliamentary_procedure.rb'><pre><a name='299'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L299'> 299</a>         AND scm.step_collection_id = sc.id
</pre></code><code title='Line 300, app/models/parliamentary_procedure.rb'><pre><a name='300'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L300'> 300</a>         AND sc.label = 'Bicameral end steps'
</pre></code><code title='Line 301, app/models/parliamentary_procedure.rb'><pre><a name='301'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L301'> 301</a>         GROUP BY wp.id
</pre></code><code title='Line 302, app/models/parliamentary_procedure.rb'><pre><a name='302'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L302'> 302</a>       "
</pre></code><code title='Line 303, app/models/parliamentary_procedure.rb'><pre><a name='303'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L303'> 303</a>     )
</pre></code><code title='Line 304, app/models/parliamentary_procedure.rb'><pre><a name='304'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L304'> 304</a>   end
</pre></code><h2>Method to add an ellipsis to a description of a procedure, if the description text is longer than 255 characters.</h2>
<code title='Line 307, app/models/parliamentary_procedure.rb'><pre><a name='307'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L307'> 307</a>   def description_massaged
</pre></code><code title='Line 308, app/models/parliamentary_procedure.rb'><pre><a name='308'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L308'> 308</a>     description.length < 256 ? description : description + " ..."
</pre></code><code title='Line 309, app/models/parliamentary_procedure.rb'><pre><a name='309'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L309'> 309</a>   end
</pre></code><code title='Line 310, app/models/parliamentary_procedure.rb'><pre><a name='310'  class='githubline' href='https://github.com/ukparliament/procedure-parsing/tree/master/app/models/parliamentary_procedure.rb#L310'> 310</a> end</pre></code></body></html>